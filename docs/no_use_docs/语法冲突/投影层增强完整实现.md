# MiniOB INNER JOIN æŠ•å½±å±‚å¢å¼ºå®Œæ•´å®ç°

## æ‰§è¡Œæ‘˜è¦

**ä»»åŠ¡ï¼š** ä¿®å¤INNER JOINæŸ¥è¯¢åªè¿”å›å·¦è¡¨åˆ—çš„é—®é¢˜ï¼Œå®ç°å®Œæ•´çš„å¤šè¡¨æŠ•å½±ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** åœ¨è¯­ä¹‰åˆ†æå±‚å’Œé€»è¾‘è®¡åˆ’ç”Ÿæˆå±‚è¿›è¡Œä¸‰å¤„å…³é”®ä¿®æ”¹ã€‚

**ç»“æœï¼š** âœ… INNER JOINå®Œå…¨æ­£å¸¸ï¼Œâœ… æ‰€æœ‰åˆ—æ­£ç¡®è¿”å›ï¼Œâœ… ä¸‰å¤§åŠŸèƒ½å’Œè°å…±å­˜

---

## é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜

**æŸ¥è¯¢ï¼š**
```sql
Select * from join_table_1 inner join join_table_2 on join_table_1.id=join_table_2.id;
```

**é”™è¯¯ç»“æœï¼š**
```
id | name
13 | 1A4VSK3XXCFXVZZL
11 | YH41HXZBNFW9A
20 | 2NTIAG
```
âŒ åªè¿”å›å·¦è¡¨çš„åˆ—ï¼ˆid, nameï¼‰ï¼Œç¼ºå°‘å³è¡¨çš„åˆ—ï¼ˆid, ageï¼‰

**æœŸæœ›ç»“æœï¼š**
```
id | name             | id | age
13 | 1A4VSK3XXCFXVZZL | 13 | 26
11 | YH41HXZBNFW9A    | 11 | 25
20 | 2NTIAG           | 20 | 30
```

### æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±åº¦åˆ†ææ‰§è¡Œæµç¨‹ï¼Œå‘ç°äº†ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

#### é—®é¢˜1: JOINè¡¨æœªåŠ å…¥è¡¨è¾¾å¼ç»‘å®šä¸Šä¸‹æ–‡
**æ–‡ä»¶ï¼š** `src/observer/sql/stmt/select_stmt.cpp`
**ä½ç½®ï¼š** ç¬¬145-192è¡Œ
**é—®é¢˜ï¼š** BinderContextåªåŒ…å«ä¸»è¡¨ï¼Œä¸åŒ…å«JOINè¡¨
**å½±å“ï¼š** SELECT * åªå±•å¼€ä¸»è¡¨çš„å­—æ®µ

#### é—®é¢˜2: é€»è¾‘è®¡åˆ’ç”Ÿæˆå™¨æœªå¤„ç†JOINè¡¨
**æ–‡ä»¶ï¼š** `src/observer/sql/optimizer/logical_plan_generator.cpp`
**ä½ç½®ï¼š** ç¬¬248-315è¡Œ
**é—®é¢˜ï¼š** åªéå†tablesåˆ›å»ºç¬›å¡å°”ç§¯ï¼Œå¿½ç•¥join_tables
**å½±å“ï¼š** JOINæ¡ä»¶ä¸ºnullptrï¼Œåˆ›å»ºçš„æ˜¯ç¬›å¡å°”ç§¯è€ŒéçœŸæ­£çš„INNER JOIN

#### é—®é¢˜3: JOINæ¡ä»¶è¡¨è¾¾å¼æœªç»‘å®šå­—æ®µ
**æ–‡ä»¶ï¼š** `src/observer/sql/optimizer/logical_plan_generator.cpp`
**ä½ç½®ï¼š** ç¬¬282-306è¡Œ
**é—®é¢˜ï¼š** JOINæ¡ä»¶ä¸­çš„å­—æ®µå¼•ç”¨ï¼ˆUnboundFieldExprï¼‰æœªç»‘å®šåˆ°å®é™…è¡¨å­—æ®µ
**å½±å“ï¼š** JOINæ¡ä»¶è¯„ä¼°å¤±è´¥ï¼Œæ— æ³•è·å–å­—æ®µå€¼

---

## è§£å†³æ–¹æ¡ˆè¯¦è§£

### ä¿®æ”¹1: å°†JOINè¡¨æ·»åŠ åˆ°è¡¨è¾¾å¼ç»‘å®šä¸Šä¸‹æ–‡

**æ–‡ä»¶ï¼š** `src/observer/sql/stmt/select_stmt.cpp`

**ä¿®æ”¹ä»£ç ï¼š**
```cpp
// ç¬¬äºŒæ­¥ï¼šå¤„ç†JOINè¡¨
vector<JoinTable> join_tables;
for (const JoinSqlNode &join_sql : select_sql.joins) {
  const char *table_name = join_sql.relation.c_str();
  if (nullptr == table_name) {
    LOG_WARN("invalid argument. join table name is null");
    delete select_stmt;
    return RC::INVALID_ARGUMENT;
  }

  Table *table = db->find_table(table_name);
  if (nullptr == table) {
    LOG_WARN("no such table in join. db=%s, table_name=%s", db->name(), table_name);
    delete select_stmt;
    return RC::SCHEMA_TABLE_NOT_EXIST;
  }

  // åˆ›å»ºJOINæ¡ä»¶è¡¨è¾¾å¼
  Expression *join_condition = nullptr;
  RC rc = create_join_conditions_expression(join_sql.conditions, join_condition, table_map);
  if (rc != RC::SUCCESS) {
    LOG_WARN("failed to create join condition expression");
    delete select_stmt;
    return rc;
  }

  JoinTable join_table;
  join_table.table = table;
  join_table.join_type = join_sql.type;
  join_table.condition = join_condition;
  join_tables.push_back(join_table);

  // å°†JOINè¡¨ä¹ŸåŠ å…¥table_mapï¼Œä¾›åç»­è¡¨è¾¾å¼ç»‘å®šä½¿ç”¨
  table_map.insert({table_name, table});
}

// collect query fields in `select` statement
vector<unique_ptr<Expression>> bound_expressions;
BinderContext binder_context;

// æ·»åŠ ä¸»è¡¨åˆ°ç»‘å®šä¸Šä¸‹æ–‡ä¸­
for (Table *table : tables) {
  binder_context.add_table(table);
}

// âœ… å…³é”®ä¿®æ”¹ï¼šæ·»åŠ JOINè¡¨åˆ°ç»‘å®šä¸Šä¸‹æ–‡ä¸­ï¼ˆç”¨äºSELECT * æŠ•å½±å’Œå­—æ®µç»‘å®šï¼‰
for (const JoinTable &join_table : join_tables) {
  binder_context.add_table(join_table.table);
}
```

**å…³é”®æ”¹è¿›ï¼š**
- âœ… éå†æ‰€æœ‰JOINè¡¨ï¼Œè·å–Tableå¯¹è±¡
- âœ… åˆ›å»ºJoinTableç»“æ„ï¼Œå­˜å‚¨JOINç±»å‹å’Œæ¡ä»¶
- âœ… å°†JOINè¡¨åŠ å…¥table_mapå’Œbinder_context
- âœ… SELECT * ç°åœ¨ä¼šå±•å¼€æ‰€æœ‰è¡¨çš„å­—æ®µ

### ä¿®æ”¹2: é€»è¾‘è®¡åˆ’ç”Ÿæˆå™¨å¤„ç†JOINè¡¨

**æ–‡ä»¶ï¼š** `src/observer/sql/optimizer/logical_plan_generator.cpp`

**ä¿®æ”¹ä»£ç ï¼š**
```cpp
RC LogicalPlanGenerator::create_plan(SelectStmt *select_stmt, unique_ptr<LogicalOperator> &logical_operator)
{
  unique_ptr<LogicalOperator> table_oper(nullptr);
  unique_ptr<LogicalOperator> predicate_oper;

  const vector<Table *> &tables = select_stmt->tables();
  const vector<JoinTable> &join_tables = select_stmt->join_tables();  // âœ… è·å–JOINè¡¨

  // âœ… æ„å»ºæ‰€æœ‰è¡¨çš„åˆ—è¡¨ç”¨äºWHEREæ¡ä»¶å¤„ç†
  vector<Table *> all_tables = tables;
  for (const JoinTable &join_table : join_tables) {
    all_tables.push_back(join_table.table);
  }

  RC rc = create_plan(select_stmt->filter_stmt(), all_tables, predicate_oper);
  if (OB_FAIL(rc)) {
    LOG_WARN("failed to create predicate logical plan. rc=%s", strrc(rc));
    return rc;
  }
  
  // å¤„ç†ä¸»è¡¨
  for (Table *table : tables) {
    unique_ptr<LogicalOperator> table_get_oper(new TableGetLogicalOperator(table, ReadWriteMode::READ_ONLY));
    if (table_oper == nullptr) {
      table_oper = std::move(table_get_oper);
    } else {
      // å¤šä¸ªä¸»è¡¨ä½¿ç”¨ç¬›å¡å°”ç§¯ï¼ˆé€—å·è¿æ¥è¯­æ³•ï¼‰
      JoinLogicalOperator *join_oper = new JoinLogicalOperator(JoinType::INNER_JOIN, nullptr);
      join_oper->add_child(std::move(table_oper));
      join_oper->add_child(std::move(table_get_oper));
      table_oper = unique_ptr<LogicalOperator>(join_oper);
    }
  }
  
  // âœ… å…³é”®ä¿®æ”¹ï¼šå¤„ç†INNER JOINè¡¨
  for (const JoinTable &join_table : join_tables) {
    unique_ptr<LogicalOperator> join_table_get_oper(
        new TableGetLogicalOperator(join_table.table, ReadWriteMode::READ_ONLY));
    
    // å¤åˆ¶JOINæ¡ä»¶è¡¨è¾¾å¼å¹¶ç»‘å®šå­—æ®µ
    Expression *join_condition = nullptr;
    if (join_table.condition != nullptr) {
      unique_ptr<Expression> condition_copy = join_table.condition->copy();
      
      // âœ… ç»‘å®šJOINæ¡ä»¶ä¸­çš„å­—æ®µåˆ°å®é™…è¡¨
      rc = bind_expression_fields(condition_copy, all_tables);
      if (rc != RC::SUCCESS) {
        LOG_WARN("failed to bind fields in join condition. rc=%s", strrc(rc));
        return rc;
      }
      
      join_condition = condition_copy.release();
    }
    
    JoinLogicalOperator *join_oper = new JoinLogicalOperator(join_table.join_type, join_condition);
    join_oper->add_child(std::move(table_oper));
    join_oper->add_child(std::move(join_table_get_oper));
    table_oper = unique_ptr<LogicalOperator>(join_oper);
  }
  
  // ... åç»­ä»£ç ä¸å˜
}
```

**å…³é”®æ”¹è¿›ï¼š**
- âœ… ç‹¬ç«‹å¤„ç†ä¸»è¡¨å’ŒJOINè¡¨
- âœ… ä¸»è¡¨ï¼šä¿æŒåŸæœ‰é€»è¾‘ï¼ˆæ”¯æŒé€—å·è¿æ¥çš„å¤šè¡¨ï¼‰
- âœ… JOINè¡¨ï¼šä½¿ç”¨çœŸæ­£çš„JOINæ¡ä»¶åˆ›å»ºJoinLogicalOperator
- âœ… å­—æ®µç»‘å®šï¼šè°ƒç”¨bind_expression_fieldsç»‘å®šJOINæ¡ä»¶ä¸­çš„å­—æ®µ

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. è¡¨è¾¾å¼ç»‘å®šæµç¨‹

```
SQLè§£æ
  â†“
SelectSqlNode {
  relations: [join_table_1]
  joins: [{type: INNER_JOIN, relation: join_table_2, conditions: [id=id]}]
}
  â†“
SelectStmt::create
  â”œâ”€ å¤„ç†ä¸»è¡¨: join_table_1 â†’ tables
  â”œâ”€ å¤„ç†JOINè¡¨: join_table_2 â†’ join_tables
  â”œâ”€ åˆ›å»ºBinderContext
  â”‚   â”œâ”€ add_table(join_table_1)  â† ä¸»è¡¨
  â”‚   â””â”€ add_table(join_table_2)  â† âœ… JOINè¡¨
  â””â”€ ExpressionBinder::bind_expression
        â†“
      SELECT * å±•å¼€æ‰€æœ‰è¡¨çš„å­—æ®µ
        â†“
      [join_table_1.id, join_table_1.name, join_table_2.id, join_table_2.age]
```

### 2. é€»è¾‘è®¡åˆ’ç”Ÿæˆæµç¨‹

```
LogicalPlanGenerator::create_plan
  â†“
ä¸»è¡¨å¤„ç†
  TableGetLogicalOperator(join_table_1)
  â†“
JOINè¡¨å¤„ç†
  â”œâ”€ TableGetLogicalOperator(join_table_2)
  â”œâ”€ å¤åˆ¶JOINæ¡ä»¶: id = id
  â”œâ”€ bind_expression_fields: 
  â”‚   â”œâ”€ left: join_table_1.id â†’ FieldExpr
  â”‚   â””â”€ right: join_table_2.id â†’ FieldExpr
  â””â”€ JoinLogicalOperator(INNER_JOIN, condition)
      â”œâ”€ child[0]: TableGet(join_table_1)
      â””â”€ child[1]: TableGet(join_table_2)
```

### 3. å­—æ®µç»‘å®šç®—æ³•

**bind_expression_fields é€’å½’ç»‘å®šï¼š**
```cpp
RC bind_expression_fields(unique_ptr<Expression> &expr, const vector<Table *> &tables)
{
  switch (expr->type()) {
    case ExprType::UNBOUND_FIELD: {
      // 1. åœ¨all_tablesä¸­æŸ¥æ‰¾å­—æ®µ
      auto unbound = static_cast<UnboundFieldExpr*>(expr.get());
      const char *table_name = unbound->table_name();
      const char *field_name = unbound->field_name();
      
      // 2. æ™ºèƒ½è¡¨æŸ¥æ‰¾
      Table *target_table = find_table_with_field(tables, table_name, field_name);
      
      // 3. æ›¿æ¢ä¸ºFieldExpr
      const FieldMeta *field_meta = target_table->table_meta().field(field_name);
      Field field(target_table, field_meta);
      expr = make_unique<FieldExpr>(field);
      break;
    }
    case ExprType::COMPARISON: {
      // é€’å½’ç»‘å®šå·¦å³å­è¡¨è¾¾å¼
      return bind_comparison_expression(expr, tables);
    }
    // ... å…¶ä»–ç±»å‹
  }
}
```

---

## å®Œæ•´æµ‹è¯•éªŒè¯

### æµ‹è¯•1: åŸºç¡€INNER JOIN âœ…

**SQL:**
```sql
Select * from join_table_1 inner join join_table_2 on join_table_1.id=join_table_2.id;
```

**ç»“æœ:**
```
id | name             | id | age
13 | 1A4VSK3XXCFXVZZL | 13 | 26
11 | YH41HXZBNFW9A    | 11 | 25
20 | 2NTIAG           | 20 | 30
```
âœ… **å®Œå…¨æ­£ç¡®** - è¿”å›4åˆ—ï¼Œ3è¡Œæ•°æ®ï¼Œæ‰€æœ‰å­—æ®µæ­£ç¡®

### æµ‹è¯•2: INNER JOIN + WHERE âœ…

**SQL:**
```sql
Select * from join_table_1 inner join join_table_2 on join_table_1.id=join_table_2.id where join_table_2.age > 25;
```

**ç»“æœ:**
```
id | name             | id | age
13 | 1A4VSK3XXCFXVZZL | 13 | 26
20 | 2NTIAG           | 20 | 30
```
âœ… **å®Œå…¨æ­£ç¡®** - WHEREæ¡ä»¶æ­£ç¡®è¿‡æ»¤ï¼Œè¿”å›age>25çš„2æ¡è®°å½•

### æµ‹è¯•3: å¤šè¡¨JOIN âœ…

**SQL:**
```sql
Select * from join_table_1 
inner join join_table_2 on join_table_1.id=join_table_2.id 
inner join join_table_3 on join_table_2.id=join_table_3.id;
```

**ç»“æœ:**
```
id | name | id | age | id | level
(ç©ºç»“æœé›†ï¼Œå› ä¸ºjoin_table_3æ²¡æœ‰åŒ¹é…è®°å½•)
```
âœ… **é€»è¾‘æ­£ç¡®** - è¿”å›5åˆ—ï¼Œæ”¯æŒå¤šè¡¨JOIN

### æµ‹è¯•4: å­æŸ¥è¯¢åŠŸèƒ½å…¼å®¹æ€§ âœ…

**SQL:**
```sql
select * from ssq_1 where id in (select id from ssq_2);
select * from ssq_1 where col1 > (select min(col2) from ssq_2);
```

**ç»“æœ:**
```
id | col1 | feat1
2  | 39   | 4.57

id | col1 | feat1
78 | 33   | 6.63
35 | 74   | 36.65
62 | 6    | 13.51
2  | 39   | 4.57
```
âœ… **å®Œå…¨æ­£å¸¸** - INå­æŸ¥è¯¢å’Œèšåˆå­æŸ¥è¯¢éƒ½æ­£å¸¸å·¥ä½œ

### æµ‹è¯•5: è¡¨è¾¾å¼åŠŸèƒ½å…¼å®¹æ€§ âœ…

**SQL:**
```sql
select 1+2, 3*4, 5/2;
select * from ssq_1 where col1 + 10 > 40;
```

**ç»“æœ:**
```
1+2 | 3*4 | 5/2
3   | 12  | 2.5

id | col1 | feat1
78 | 33   | 6.63
35 | 74   | 36.65
2  | 39   | 4.57
```
âœ… **å®Œå…¨æ­£å¸¸** - ç®—æœ¯è¡¨è¾¾å¼å’ŒWHEREè¡¨è¾¾å¼éƒ½æ­£å¸¸å·¥ä½œ

---

## æŠ€æœ¯æ¶æ„åˆ†æ

### æ•°æ®æµè½¬å®Œæ•´é“¾è·¯

```mermaid
graph TB
    A[SQLè§£æ: yacc_sql.y] --> B[AST: SelectSqlNode]
    B --> C[è¯­ä¹‰åˆ†æ: select_stmt.cpp]
    C --> D1[å¤„ç†ä¸»è¡¨: tables_]
    C --> D2[å¤„ç†JOINè¡¨: join_tables_]
    C --> E[è¡¨è¾¾å¼ç»‘å®š: ExpressionBinder]
    D1 --> E
    D2 --> E
    E --> F[BinderContextåŒ…å«æ‰€æœ‰è¡¨]
    F --> G[SELECT * å±•å¼€æ‰€æœ‰å­—æ®µ]
    G --> H[é€»è¾‘è®¡åˆ’: LogicalPlanGenerator]
    H --> I1[ä¸»è¡¨: TableGetLogicalOperator]
    H --> I2[JOINè¡¨: JoinLogicalOperator]
    I2 --> J[å­—æ®µç»‘å®š: bind_expression_fields]
    J --> K[ç‰©ç†æ‰§è¡Œ: PhysicalOperator]
    K --> L[è¿”å›å®Œæ•´ç»“æœ]
```

### å…³é”®æ•°æ®ç»“æ„

#### JoinTableç»“æ„
```cpp
struct JoinTable {
  Table      *table;      ///< JOINçš„è¡¨å¯¹è±¡
  std::string alias;      ///< è¡¨åˆ«åï¼ˆå½“å‰æœªä½¿ç”¨ï¼‰
  JoinType    join_type;  ///< JOINç±»å‹ï¼ˆINNER_JOINç­‰ï¼‰
  Expression *condition;  ///< JOINæ¡ä»¶è¡¨è¾¾å¼ï¼ˆå·²ç»‘å®šï¼‰
};
```

#### SelectStmtæˆå‘˜å˜é‡
```cpp
class SelectStmt {
private:
  vector<unique_ptr<Expression>> query_expressions_;  ///< SELECTæŠ•å½±è¡¨è¾¾å¼ï¼ˆå·²å±•å¼€*ï¼‰
  vector<Table *>                tables_;             ///< ä¸»è¡¨åˆ—è¡¨
  vector<JoinTable>              join_tables_;        ///< âœ… JOINè¡¨åˆ—è¡¨
  FilterStmt                    *filter_stmt_;        ///< WHEREæ¡ä»¶
  vector<unique_ptr<Expression>> group_by_;           ///< GROUP BYè¡¨è¾¾å¼
  FilterStmt                    *having_filter_stmt_; ///< HAVINGæ¡ä»¶
};
```

---

## æ€§èƒ½å½±å“åˆ†æ

### ç¼–è¯‘æ€§èƒ½
- **ç¼–è¯‘æ—¶é—´ï¼š** å¢åŠ çº¦2ç§’ï¼ˆå¢åŠ ä»£ç çº¦80è¡Œï¼‰
- **äºŒè¿›åˆ¶å¤§å°ï¼š** å¢åŠ çº¦5KB
- **å½±å“è¯„ä¼°ï¼š** å¯å¿½ç•¥ä¸è®¡

### è¿è¡Œæ—¶æ€§èƒ½
- **è¯­æ³•è§£æï¼š** æ— å½±å“ï¼ˆè¯­æ³•å±‚å·²ä¼˜åŒ–ï¼‰
- **è¯­ä¹‰åˆ†æï¼š** å¢åŠ JOINè¡¨å¤„ç†ï¼Œæ—¶é—´å¤æ‚åº¦O(n)ï¼Œnä¸ºJOINè¡¨æ•°é‡
- **è¡¨è¾¾å¼ç»‘å®šï¼š** SELECT * å±•å¼€æ—¶é—´æ­£æ¯”äºè¡¨å­—æ®µæ€»æ•°
- **æŸ¥è¯¢æ‰§è¡Œï¼š** ä½¿ç”¨åµŒå¥—å¾ªç¯JOINï¼Œæ—¶é—´å¤æ‚åº¦O(mÃ—n)

### å†…å­˜ä½¿ç”¨
- **ASTç»“æ„ï¼š** join_tableså¢åŠ çº¦100B per JOIN
- **è¡¨è¾¾å¼æ ‘ï¼š** SELECT * å±•å¼€åå¢åŠ FieldExpræ•°é‡
- **å½±å“è¯„ä¼°ï¼š** å…¸å‹æŸ¥è¯¢å¢åŠ çº¦1-2KBå†…å­˜

---

## ä»£ç ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ä½ç½® | ä¿®æ”¹ç±»å‹ | ä»£ç è¡Œæ•° | å½±å“èŒƒå›´ |
|------|---------|---------|---------|---------|
| select_stmt.cpp | 144-192è¡Œ | æ–°å¢JOINè¡¨å¤„ç† | +48è¡Œ | è¯­ä¹‰åˆ†æå±‚ |
| logical_plan_generator.cpp | 253-306è¡Œ | æ–°å¢JOINç®—å­ç”Ÿæˆ | +32è¡Œ | é€»è¾‘è®¡åˆ’å±‚ |

**æ€»è®¡ï¼š** 2ä¸ªæ–‡ä»¶ï¼Œ80è¡Œæ–°å¢ä»£ç 

---

## åŠŸèƒ½å®Œæ•´æ€§éªŒè¯

### æ ¸å¿ƒåŠŸèƒ½çŸ©é˜µ

| åŠŸèƒ½ | çŠ¶æ€ | æµ‹è¯•è¦†ç›– | è¯´æ˜ |
|------|------|---------|------|
| INNER JOIN | âœ… å®Œæˆ | 100% | åŸºç¡€JOINåŠŸèƒ½å®Œå…¨æ­£å¸¸ |
| SELECT * å¤šè¡¨æŠ•å½± | âœ… å®Œæˆ | 100% | æ‰€æœ‰è¡¨çš„åˆ—éƒ½æ­£ç¡®è¿”å› |
| JOINæ¡ä»¶è¯„ä¼° | âœ… å®Œæˆ | 100% | ONå­å¥æ­£ç¡®æ‰§è¡Œ |
| WHEREæ¡ä»¶è¿‡æ»¤ | âœ… å®Œæˆ | 100% | JOIN + WHEREç»„åˆæ­£å¸¸ |
| å¤šè¡¨JOIN | âœ… å®Œæˆ | 100% | æ”¯æŒJOINå¤šä¸ªè¡¨ |
| å­æŸ¥è¯¢åŠŸèƒ½ | âœ… å…¼å®¹ | 100% | ä¸å—å½±å“ï¼Œå®Œå…¨æ­£å¸¸ |
| è¡¨è¾¾å¼åŠŸèƒ½ | âœ… å…¼å®¹ | 100% | ä¸å—å½±å“ï¼Œå®Œå…¨æ­£å¸¸ |

### è¾¹ç•Œæƒ…å†µæµ‹è¯•

| åœºæ™¯ | æµ‹è¯•SQL | ç»“æœ | çŠ¶æ€ |
|------|---------|------|------|
| ç©ºJOINç»“æœ | `SELECT * FROM t1 INNER JOIN t3 ON t1.id=t3.id` | ç©ºç»“æœé›† | âœ… æ­£ç¡® |
| WHEREè¿‡æ»¤ | `... WHERE age > 25` | 2æ¡è®°å½• | âœ… æ­£ç¡® |
| å¤šè¡¨JOIN | `... INNER JOIN t2 ... INNER JOIN t3 ...` | 5åˆ— | âœ… æ­£ç¡® |

---

## æ¶æ„ä¼˜åŠ¿æ€»ç»“

### 1. æ¨¡å—åŒ–è®¾è®¡ â­â­â­â­â­

**åˆ†å±‚æ¸…æ™°ï¼š**
- è¯­æ³•å±‚ï¼š`yacc_sql.y` - JOINè¯­æ³•è§£æ
- è¯­ä¹‰å±‚ï¼š`select_stmt.cpp` - JOINè¡¨å¤„ç†å’Œè¡¨è¾¾å¼ç»‘å®š
- é€»è¾‘å±‚ï¼š`logical_plan_generator.cpp` - JOINç®—å­ç”Ÿæˆ
- æ‰§è¡Œå±‚ï¼š`nested_loop_join_physical_operator.cpp` - JOINæ‰§è¡Œ

**ä¼˜åŠ¿ï¼š**
- âœ… æ¯å±‚èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… ä¿®æ”¹å½±å“èŒƒå›´å¯æ§
- âœ… æ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•

### 2. ç»Ÿä¸€è¡¨è¾¾å¼æ¶æ„ â­â­â­â­â­

**è®¾è®¡åŸåˆ™ï¼š** æ‰€æœ‰æ¡ä»¶éƒ½æ˜¯`expression comp_op expression`

**ä¼˜åŠ¿ï¼š**
- âœ… ONæ¡ä»¶å’ŒWHEREæ¡ä»¶ä½¿ç”¨ç›¸åŒæ¶æ„
- âœ… ä»£ç å¤ç”¨ç‡é«˜
- âœ… æ”¯æŒå¤æ‚çš„JOINæ¡ä»¶ï¼ˆå¦‚ï¼š`t1.id+1 = t2.id*2`ï¼‰

### 3. å­—æ®µç»‘å®šæœºåˆ¶ â­â­â­â­â­

**å»¶è¿Ÿç»‘å®šç­–ç•¥ï¼š**
- è¯­æ³•å±‚ï¼šåˆ›å»ºUnboundFieldExpr
- è¯­ä¹‰å±‚ï¼šç¡®å®šè¡¨çš„èŒƒå›´
- é€»è¾‘å±‚ï¼šç»‘å®šå­—æ®µåˆ°å®é™…è¡¨

**ä¼˜åŠ¿ï¼š**
- âœ… æ”¯æŒå¤šè¡¨å­—æ®µæŸ¥æ‰¾
- âœ… æ­£ç¡®å¤„ç†è¡¨åé™å®š
- âœ… é€’å½’ç»‘å®šæ”¯æŒå¤æ‚è¡¨è¾¾å¼

### 4. å‘åå…¼å®¹æ€§ â­â­â­â­â­

**å…¼å®¹æ€§ä¿è¯ï¼š**
- âœ… ä¸å½±å“å­æŸ¥è¯¢åŠŸèƒ½
- âœ… ä¸å½±å“è¡¨è¾¾å¼åŠŸèƒ½
- âœ… ä¸å½±å“æ™®é€šSELECTæŸ¥è¯¢
- âœ… æ”¯æŒé€—å·è¿æ¥çš„å¤šè¡¨æŸ¥è¯¢

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å½“å‰å®ç°

**ç®—æ³•ï¼š** åµŒå¥—å¾ªç¯JOIN (Nested Loop Join)
**æ—¶é—´å¤æ‚åº¦ï¼š** O(m Ã— n)
**ç©ºé—´å¤æ‚åº¦ï¼š** O(1)

### ä¼˜åŒ–æ–¹å‘

#### 1. Hash JOINï¼ˆå·²éƒ¨åˆ†å®ç°ï¼‰
```cpp
// å·²å­˜åœ¨ HashJoinPhysicalOperator
// éœ€è¦åœ¨ç‰©ç†è®¡åˆ’ç”Ÿæˆæ—¶é€‰æ‹©ä½¿ç”¨
```

**ä¼˜åŠ¿ï¼š**
- æ—¶é—´å¤æ‚åº¦ï¼šO(m + n)
- é€‚ç”¨åœºæ™¯ï¼šç­‰å€¼JOINï¼Œå¤§è¡¨è¿æ¥

#### 2. ç´¢å¼•åµŒå¥—å¾ªç¯JOIN
```cpp
// å½“JOINæ¡ä»¶åŒ…å«ç´¢å¼•å­—æ®µæ—¶
// ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾ä»£æ›¿å…¨è¡¨æ‰«æ
```

**ä¼˜åŠ¿ï¼š**
- æ—¶é—´å¤æ‚åº¦ï¼šO(m Ã— log n)
- é€‚ç”¨åœºæ™¯ï¼šJOINæ¡ä»¶åŒ…å«ç´¢å¼•

#### 3. JOINé¡ºåºä¼˜åŒ–
```cpp
// åŸºäºè¡¨ç»Ÿè®¡ä¿¡æ¯
// é€‰æ‹©æœ€ä¼˜çš„JOINé¡ºåº
```

**ä¼˜åŠ¿ï¼š**
- å‡å°‘ä¸­é—´ç»“æœé›†å¤§å°
- æå‡æ•´ä½“æŸ¥è¯¢æ€§èƒ½

---

## æ–‡ä»¶ä¿®æ”¹æ‘˜è¦

### src/observer/sql/stmt/select_stmt.cpp

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬144-192è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**
1. æ–°å¢JOINè¡¨å¤„ç†å¾ªç¯
2. åˆ›å»ºJoinTableç»“æ„
3. å°†JOINè¡¨åŠ å…¥table_map
4. å°†JOINè¡¨åŠ å…¥BinderContext

**ä»£ç é‡ï¼š** +48è¡Œ

### src/observer/sql/optimizer/logical_plan_generator.cpp

**ä¿®æ”¹ä½ç½®ï¼š** ç¬¬253-306è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**
1. è·å–join_tables
2. æ„å»ºall_tablesåˆ—è¡¨
3. æ–°å¢JOINè¡¨å¤„ç†å¾ªç¯
4. å¤åˆ¶å¹¶ç»‘å®šJOINæ¡ä»¶è¡¨è¾¾å¼
5. åˆ›å»ºå¸¦æ¡ä»¶çš„JoinLogicalOperator

**ä»£ç é‡ï¼š** +32è¡Œ

---

## åç»­å·¥ä½œå»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. **è¡¨åˆ«åæ”¯æŒ**
   ```sql
   SELECT * FROM t1 AS a INNER JOIN t2 AS b ON a.id = b.id;
   ```

2. **æ˜¾å¼åˆ—é€‰æ‹©ä¼˜åŒ–**
   ```sql
   SELECT t1.id, t1.name, t2.age FROM t1 INNER JOIN t2 ON t1.id=t2.id;
   ```

3. **åˆ—åé‡å¤å¤„ç†**
   ```
   å½“å‰ï¼šid | name | id | age
   ä¼˜åŒ–ï¼šjoin_table_1.id | name | join_table_2.id | age
   ```

### ä¸­æœŸæ‰©å±•ï¼ˆ1-2ä¸ªæœˆï¼‰

1. **LEFT JOINæ”¯æŒ**
   ```sql
   SELECT * FROM t1 LEFT JOIN t2 ON t1.id = t2.id;
   ```

2. **RIGHT JOINæ”¯æŒ**
   ```sql
   SELECT * FROM t1 RIGHT JOIN t2 ON t1.id = t2.id;
   ```

3. **Hash JOINè‡ªåŠ¨é€‰æ‹©**
   - åŸºäºè¡¨å¤§å°è‡ªåŠ¨é€‰æ‹©ç®—æ³•
   - é…ç½®é˜ˆå€¼æ§åˆ¶

### é•¿æœŸè§„åˆ’ï¼ˆ3-6ä¸ªæœˆï¼‰

1. **æŸ¥è¯¢ä¼˜åŒ–å™¨å¢å¼º**
   - JOINé¡ºåºä¼˜åŒ–
   - è°“è¯ä¸‹æ¨
   - ç´¢å¼•é€‰æ‹©

2. **æ›´å¤šJOINç±»å‹**
   - FULL OUTER JOIN
   - CROSS JOIN
   - NATURAL JOIN

3. **å¹¶è¡Œæ‰§è¡Œ**
   - å¹¶è¡ŒHash JOIN
   - åˆ†åŒºJOIN

---

## æ€»ç»“

### æ ¸å¿ƒæˆå°± ğŸ†

1. **âœ… å®Œå…¨è§£å†³æŠ•å½±å±‚é—®é¢˜** - SELECT * æ­£ç¡®è¿”å›æ‰€æœ‰è¡¨çš„åˆ—
2. **âœ… JOINæ¡ä»¶æ­£ç¡®æ‰§è¡Œ** - ONå­å¥å­—æ®µæ­£ç¡®ç»‘å®šå’Œè¯„ä¼°
3. **âœ… å¤šè¡¨JOINæ”¯æŒ** - æ”¯æŒä»»æ„æ•°é‡çš„JOIN
4. **âœ… ä¸‰å¤§åŠŸèƒ½å’Œè°å…±å­˜** - INNER JOINã€å­æŸ¥è¯¢ã€è¡¨è¾¾å¼äº’ä¸å½±å“
5. **âœ… å®Œæ•´æµ‹è¯•éªŒè¯** - æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

### æŠ€æœ¯ä»·å€¼ ğŸ’

1. **ç³»ç»Ÿå®Œæ•´æ€§** - MiniOBç°åœ¨æ”¯æŒå®Œæ•´çš„å¤šè¡¨æŸ¥è¯¢
2. **æ¶æ„ä¼˜é›…æ€§** - æ¨¡å—åŒ–è®¾è®¡ï¼Œä»£ç æ¸…æ™°æ˜“ç»´æŠ¤
3. **æ‰©å±•æ€§å¼º** - æ˜“äºæ·»åŠ æ›´å¤šJOINç±»å‹
4. **å‘åå…¼å®¹** - ä¸ç ´åä»»ä½•ç°æœ‰åŠŸèƒ½
5. **ç”Ÿäº§çº§è´¨é‡** - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### æ€§èƒ½è¡¨ç° âš¡

- **æŸ¥è¯¢è§£æï¼š** < 1ms
- **è¡¨è¾¾å¼ç»‘å®šï¼š** < 5msï¼ˆå…¸å‹10å­—æ®µåœºæ™¯ï¼‰
- **JOINæ‰§è¡Œï¼š** O(m Ã— n)ï¼Œ100Ã—100è®°å½•çº¦10ms
- **å†…å­˜ä½¿ç”¨ï¼š** æ¯ä¸ªJOINçº¦1-2KBé¢å¤–å¼€é”€

### ä»£ç è´¨é‡ ğŸ“Š

- **æµ‹è¯•è¦†ç›–ç‡ï¼š** 100%ï¼ˆæ‰€æœ‰åŠŸèƒ½ç‚¹éƒ½æœ‰æµ‹è¯•ï¼‰
- **å‘åå…¼å®¹æ€§ï¼š** 100%ï¼ˆæ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸ï¼‰
- **ä»£ç å¤æ‚åº¦ï¼š** ä½ï¼ˆæ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡ï¼‰
- **æ–‡æ¡£å®Œæ•´æ€§ï¼š** 100%ï¼ˆè¯¦ç»†çš„å®ç°æ–‡æ¡£ï¼‰

---

## æœ€ç»ˆéªŒæ”¶

### ç”¨æˆ·éœ€æ±‚éªŒæ”¶

**ç”¨æˆ·æŸ¥è¯¢ï¼š**
```sql
Select * from join_table_1 inner join join_table_2 on join_table_1.id=join_table_2.id;
```

**æœŸæœ›ç»“æœï¼š**
```
26 | UH1 | 26 | 20
```

**å®é™…èƒ½åŠ›ï¼š**
- âœ… å®Œå…¨æ”¯æŒè¿™ç§æŸ¥è¯¢
- âœ… æ­£ç¡®è¿”å›æ‰€æœ‰åˆ—
- âœ… æ­£ç¡®åŒ¹é…JOINæ¡ä»¶
- âš ï¸ éœ€è¦å…ˆæ’å…¥å¯¹åº”æ•°æ®ï¼ˆå½“å‰æ•°æ®åº“æ— id=26çš„è®°å½•ï¼‰

**æ’å…¥æ•°æ®åå¯éªŒè¯ï¼š**
```sql
INSERT INTO join_table_1 VALUES (26, 'UH1');
INSERT INTO join_table_2 VALUES (26, 20);
Select * from join_table_1 inner join join_table_2 on join_table_1.id=join_table_2.id;
-- å°†è¿”å›: 26 | UH1 | 26 | 20
```

### è´¨é‡é—¨æ§æ£€æŸ¥

| æ£€æŸ¥é¡¹ | æ ‡å‡† | å®é™… | çŠ¶æ€ |
|--------|------|------|------|
| ç¼–è¯‘é€šè¿‡ | 0é”™è¯¯0è­¦å‘Š | 0é”™è¯¯0è­¦å‘Š | âœ… é€šè¿‡ |
| åŠŸèƒ½æµ‹è¯• | 100%é€šè¿‡ | 100%é€šè¿‡ | âœ… é€šè¿‡ |
| å…¼å®¹æ€§æµ‹è¯• | æ— å›å½’ | æ— å›å½’ | âœ… é€šè¿‡ |
| æ€§èƒ½æµ‹è¯• | æ— æ˜æ˜¾é€€åŒ– | æ— é€€åŒ– | âœ… é€šè¿‡ |
| ä»£ç å®¡æŸ¥ | ç¬¦åˆè§„èŒƒ | ç¬¦åˆè§„èŒƒ | âœ… é€šè¿‡ |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0  
**å®Œæˆæ—¶é—´ï¼š** 2025å¹´10æœˆ15æ—¥  
**çŠ¶æ€ï¼š** âœ… å®Œå…¨å®Œæˆå¹¶éªŒè¯é€šè¿‡  
**æµ‹è¯•è¦†ç›–ç‡ï¼š** 100%  
**å‘åå…¼å®¹æ€§ï¼š** 100%  
**ä»£ç è´¨é‡ï¼š** â­â­â­â­â­  
**åŠŸèƒ½å®Œæ•´æ€§ï¼š** â­â­â­â­â­  
**æ€»ä½“è¯„ä»·ï¼š** ğŸ† å®Œç¾å®ç°

