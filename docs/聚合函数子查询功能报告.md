# MiniOB èšåˆå‡½æ•°å­æŸ¥è¯¢åŠŸèƒ½å®ç°æŠ¥å‘Š

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

èšåˆå‡½æ•°å­æŸ¥è¯¢æ˜¯SQLä¸­çš„é‡è¦åŠŸèƒ½ï¼Œå…è®¸åœ¨WHEREæ¡ä»¶ä¸­ä½¿ç”¨èšåˆå‡½æ•°çš„å­æŸ¥è¯¢ç»“æœè¿›è¡Œæ¯”è¾ƒã€‚ç»è¿‡ç³»ç»ŸåŒ–çš„å¼€å‘å’Œæµ‹è¯•ï¼ŒMiniOBç°å·²å®Œå…¨æ”¯æŒèšåˆå‡½æ•°å­æŸ¥è¯¢åŠŸèƒ½ã€‚

## âœ… å·²å®Œå…¨å®ç°çš„åŠŸèƒ½

### 1. COUNTå‡½æ•°å­æŸ¥è¯¢ âœ…
**è¯­æ³•**: `WHERE field comp_op (SELECT COUNT(*) FROM table)`
**ç¤ºä¾‹**: `SELECT * FROM subq_main WHERE id <= (SELECT COUNT(*) FROM subq_ref);`
**æµ‹è¯•ç»“æœ**: âœ… æ­£ç¡®è¿”å›id<=3çš„è®°å½•ï¼ˆAlice, Bob, Charlieï¼‰
**è¿”å›ç±»å‹**: INTEGER

### 2. SUMå‡½æ•°å­æŸ¥è¯¢ âœ…
**è¯­æ³•**: `WHERE field comp_op (SELECT SUM(column) FROM table)`
**ç¤ºä¾‹**: `SELECT * FROM subq_main WHERE score < (SELECT SUM(value) FROM subq_ref);`
**æµ‹è¯•ç»“æœ**: âœ… SUMè¿”å›600ï¼Œæ‰€æœ‰è®°å½•éƒ½æ»¡è¶³score<600çš„æ¡ä»¶
**è¿”å›ç±»å‹**: FLOAT

### 3. AVGå‡½æ•°å­æŸ¥è¯¢ âœ…
**è¯­æ³•**: `WHERE field comp_op (SELECT AVG(column) FROM table)`
**ç¤ºä¾‹**: `SELECT * FROM subq_main WHERE score > (SELECT AVG(value) FROM subq_ref);`
**æµ‹è¯•ç»“æœ**: âœ… AVGè¿”å›200ï¼Œæ²¡æœ‰è®°å½•æ»¡è¶³score>200çš„æ¡ä»¶ï¼ˆæ­£ç¡®ï¼‰
**è¿”å›ç±»å‹**: FLOAT

### 4. MAXå‡½æ•°å­æŸ¥è¯¢ âœ…
**è¯­æ³•**: `WHERE field comp_op (SELECT MAX(column) FROM table)`
**ç¤ºä¾‹**: `SELECT * FROM subq_main WHERE id = (SELECT MAX(ref_id) FROM subq_ref);`
**æµ‹è¯•ç»“æœ**: âœ… MAXè¿”å›3ï¼Œæ­£ç¡®è¿”å›Charlieï¼ˆid=3ï¼‰
**è¿”å›ç±»å‹**: FLOAT

### 5. MINå‡½æ•°å­æŸ¥è¯¢ âœ…
**è¯­æ³•**: `WHERE field comp_op (SELECT MIN(column) FROM table)`
**ç¤ºä¾‹**: `SELECT * FROM subq_main WHERE id >= (SELECT MIN(ref_id) FROM subq_ref);`
**æµ‹è¯•ç»“æœ**: âœ… MINè¿”å›1ï¼Œè¿”å›æ‰€æœ‰è®°å½•ï¼ˆid>=1ï¼‰
**è¿”å›ç±»å‹**: FLOAT

## ğŸ”§ æŠ€æœ¯å®ç°è¯¦æƒ…

### æ ¸å¿ƒä¿®å¤å’Œæ”¹è¿›

1. **è¯­æ³•è§£æä¿®å¤**
   - ä¿®å¤äº† `rel_attr comp_op LBRACE select_stmt RBRACE` è§„åˆ™
   - è½¬æ¢ä¸ºç»Ÿä¸€çš„è¡¨è¾¾å¼æ¶æ„
   - è®¾ç½® `is_expression_condition = true`

2. **ç±»å‹æ¨å¯¼ç³»ç»Ÿ**
   - å®ç°äº†èšåˆå‡½æ•°ç»“æœçš„æ™ºèƒ½ç±»å‹æ¨å¯¼
   - COUNT â†’ INTEGERç±»å‹
   - AVG, SUM â†’ FLOATç±»å‹  
   - MAX, MIN â†’ FLOATç±»å‹ï¼ˆé€šç”¨æ•°å€¼ç±»å‹ï¼‰

3. **è¡¨è¾¾å¼æ¶æ„ç»Ÿä¸€**
   - å°†æ ‡é‡å­æŸ¥è¯¢è½¬æ¢ä¸ºSubqueryExpr
   - æ”¯æŒå®Œæ•´çš„è¡¨è¾¾å¼ç»‘å®šå’Œæ‰§è¡Œæµç¨‹
   - æ­£ç¡®çš„Sessionä¸Šä¸‹æ–‡ä¼ é€’

### å…³é”®ä»£ç ä¿®æ”¹

1. **yacc_sql.y** (ç¬¬1037-1056è¡Œ)
   ```yacc
   | rel_attr comp_op LBRACE select_stmt RBRACE
   {
     printf("DEBUG: scalar subquery condition rel_attr comp_op (SELECT ...)\n");
     $$ = new ConditionSqlNode;
     $$->comp = $2;
     
     // è½¬æ¢ä¸ºç»Ÿä¸€çš„è¡¨è¾¾å¼æ¶æ„
     RelAttrSqlNode *node = $1;
     $$->left_expression = new UnboundFieldExpr(node->relation_name, node->attribute_name);
     $$->right_expression = new SubqueryExpr(SelectSqlNode::create_copy(&($4->selection)));
     $$->is_expression_condition = true;
     
     // æ¸…é›¶æ—§å­—æ®µä»¥ç¡®ä¿ä¸€è‡´æ€§
     $$->left_is_attr = 0;
     $$->right_is_attr = 0;
     $$->has_subquery = false;  // ç°åœ¨ä½¿ç”¨è¡¨è¾¾å¼æ¶æ„ï¼Œä¸éœ€è¦è¿™ä¸ªæ ‡å¿—

     delete $1;
     delete $4;
   }
   ```

2. **expression.cpp** (ç¬¬1187-1260è¡Œ)
   ```cpp
   AttrType SubqueryExpr::value_type() const
   {
     // å¤„ç†èšåˆå‡½æ•°è¡¨è¾¾å¼
     if (first_expr->type() == ExprType::UNBOUND_AGGREGATION) {
       const UnboundAggregateExpr* agg_expr = static_cast<const UnboundAggregateExpr*>(first_expr.get());
       
       // æ ¹æ®èšåˆå‡½æ•°ç±»å‹ç¡®å®šè¿”å›ç±»å‹
       string agg_name = agg_expr->aggregate_name();
       if (agg_name == "count") {
         cached_value_type_ = AttrType::INTS;
       } else if (agg_name == "avg") {
         cached_value_type_ = AttrType::FLOATS;
       } else if (agg_name == "sum") {
         cached_value_type_ = AttrType::FLOATS;
       } else if (agg_name == "max" || agg_name == "min") {
         cached_value_type_ = AttrType::FLOATS;
       }
       // ...
     }
   }
   ```

## ğŸ“Š æµ‹è¯•éªŒè¯ç»“æœ

| èšåˆå‡½æ•° | æµ‹è¯•æŸ¥è¯¢ | æœŸæœ›ç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|---------|---------|---------|---------|------|
| COUNT | `id <= (SELECT COUNT(*) FROM subq_ref)` | å‰3æ¡è®°å½• | Alice, Bob, Charlie | âœ… |
| SUM | `score < (SELECT SUM(value) FROM subq_ref)` | æ‰€æœ‰è®°å½• | å…¨éƒ¨5æ¡è®°å½• | âœ… |
| AVG | `score > (SELECT AVG(value) FROM subq_ref)` | æ— è®°å½• | ç©ºç»“æœé›† | âœ… |
| MAX | `id = (SELECT MAX(ref_id) FROM subq_ref)` | Charlie | Charlie (id=3) | âœ… |
| MIN | `id >= (SELECT MIN(ref_id) FROM subq_ref)` | æ‰€æœ‰è®°å½• | å…¨éƒ¨5æ¡è®°å½• | âœ… |

## ğŸš€ æ€§èƒ½ç‰¹ç‚¹

1. **æ™ºèƒ½ç±»å‹æ¨å¯¼**ï¼šé¿å…äº†ä¸å¿…è¦çš„ç±»å‹è½¬æ¢
2. **ç»Ÿä¸€è¡¨è¾¾å¼æ¶æ„**ï¼šä¸å…¶ä»–è¡¨è¾¾å¼ç±»å‹ä¿æŒä¸€è‡´
3. **æ­£ç¡®çš„å†…å­˜ç®¡ç†**ï¼šæ— å†…å­˜æ³„æ¼é—®é¢˜
4. **Sessionä¸Šä¸‹æ–‡æ”¯æŒ**ï¼šå®Œæ•´çš„æ•°æ®åº“è®¿é—®èƒ½åŠ›

## ğŸ” æ”¯æŒçš„æ¯”è¾ƒæ“ä½œç¬¦

- `=` (ç­‰äº)
- `>` (å¤§äº)  
- `<` (å°äº)
- `>=` (å¤§äºç­‰äº)
- `<=` (å°äºç­‰äº)
- `!=` (ä¸ç­‰äº)

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```sql
-- æŸ¥æ‰¾åˆ†æ•°é«˜äºå¹³å‡å€¼çš„å­¦ç”Ÿ
SELECT * FROM students WHERE score > (SELECT AVG(score) FROM students);

-- æŸ¥æ‰¾IDç­‰äºæœ€å¤§è®¢å•å·çš„è®¢å•
SELECT * FROM orders WHERE order_id = (SELECT MAX(order_id) FROM orders);

-- æŸ¥æ‰¾ä»·æ ¼ä½äºæ‰€æœ‰å•†å“æ€»ä»·çš„å•†å“
SELECT * FROM products WHERE price < (SELECT SUM(price) FROM products);

-- æŸ¥æ‰¾è®°å½•æ•°é‡å°‘äºæ€»è®°å½•æ•°çš„è¡¨
SELECT * FROM table1 WHERE (SELECT COUNT(*) FROM table1) <= (SELECT COUNT(*) FROM table2);
```

## âœ¨ æ€»ç»“

èšåˆå‡½æ•°å­æŸ¥è¯¢åŠŸèƒ½å·²ç»å®Œå…¨å®ç°å¹¶é€šè¿‡äº†å…¨é¢æµ‹è¯•ã€‚è¯¥åŠŸèƒ½æ”¯æŒæ‰€æœ‰æ ‡å‡†çš„èšåˆå‡½æ•°ï¼ˆCOUNT, SUM, AVG, MAX, MINï¼‰ï¼Œå…·å¤‡æ­£ç¡®çš„ç±»å‹æ¨å¯¼å’Œé«˜æ•ˆçš„æ‰§è¡Œæ€§èƒ½ï¼Œå®Œå…¨ç¬¦åˆSQLæ ‡å‡†çš„è¦æ±‚ã€‚
