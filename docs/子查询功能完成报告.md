# MiniOB å­æŸ¥è¯¢åŠŸèƒ½å®ŒæˆæŠ¥å‘Š

## ðŸŽ¯ ä»»åŠ¡å®Œæˆæ€»ç»“

æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œæˆ‘å·²ç»æˆåŠŸå®Œå–„äº†MiniOBæ•°æ®åº“çš„å­æŸ¥è¯¢åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯**è¡¨è¾¾å¼ä¸­ä¸åŒç±»åž‹å€¼æ¯”è¾ƒ**çš„åŠŸèƒ½ã€‚çŽ°åœ¨ç³»ç»Ÿå®Œå…¨æ”¯æŒå¤æ‚çš„å­æŸ¥è¯¢æ“ä½œå’Œç±»åž‹è½¬æ¢ã€‚

## âœ… å·²å®Œå…¨å®žçŽ°çš„åŠŸèƒ½

### 1. IN/NOT IN æ“ä½œ âœ…
- **å€¼åˆ—è¡¨å½¢å¼**: `WHERE id IN (1, 2, 3)`
- **å­æŸ¥è¯¢å½¢å¼**: `WHERE id IN (SELECT ref_id FROM table)`
- **NOT INæ“ä½œ**: `WHERE id NOT IN (SELECT ref_id FROM table)`
- **æµ‹è¯•çŠ¶æ€**: å®Œå…¨é€šè¿‡ âœ…

### 2. EXISTS/NOT EXISTS æ“ä½œ âœ…
- **EXISTS**: `WHERE EXISTS (SELECT 1 FROM table WHERE condition)`
- **NOT EXISTS**: `WHERE NOT EXISTS (SELECT 1 FROM table WHERE condition)`
- **æµ‹è¯•çŠ¶æ€**: å®Œå…¨é€šè¿‡ âœ…

### 3. æ ‡é‡å­æŸ¥è¯¢æ¯”è¾ƒè¿ç®— âœ…
- **å­—æ®µä¸Žå­æŸ¥è¯¢**: `WHERE id = (SELECT MAX(ref_id) FROM table)`
- **å­æŸ¥è¯¢ä¸Žå­—æ®µ**: `WHERE (SELECT id FROM table WHERE col = value) = field` â­ **æ–°å¢žæ”¯æŒ**
- **æ‰€æœ‰æ¯”è¾ƒæ“ä½œç¬¦**: =, !=, >, <, >=, <=
- **æµ‹è¯•çŠ¶æ€**: å®Œå…¨é€šè¿‡ âœ…

### 4. èšåˆå‡½æ•°å­æŸ¥è¯¢ âœ…
- **COUNT**: `WHERE id = (SELECT COUNT(*) FROM table)`
- **AVG**: `WHERE score > (SELECT AVG(value) FROM table)`
- **SUM**: `WHERE score < (SELECT SUM(value) FROM table)`
- **MAX/MIN**: `WHERE id = (SELECT MAX(ref_id) FROM table)`
- **ç±»åž‹æŽ¨å¯¼**: æ­£ç¡®æŽ¨å¯¼èšåˆå‡½æ•°è¿”å›žç±»åž‹
- **æµ‹è¯•çŠ¶æ€**: å®Œå…¨é€šè¿‡ âœ…

### 5. ç±»åž‹è½¬æ¢ç³»ç»Ÿ âœ… â­ **é‡ç‚¹å®Œå–„**
- **æ•°å€¼ç±»åž‹è½¬æ¢**: INT â†” FLOAT è‡ªåŠ¨è½¬æ¢
- **å­—ç¬¦ä¸²è½¬æ¢**: STRING â†” æ•°å€¼ç±»åž‹è‡ªåŠ¨è½¬æ¢
- **èšåˆå‡½æ•°ç±»åž‹**: æ­£ç¡®å¤„ç†èšåˆå‡½æ•°è¿”å›žç±»åž‹
- **å¸ƒå°”ç±»åž‹è½¬æ¢**: BOOLEAN â†” æ•°å€¼ç±»åž‹è½¬æ¢
- **æµ‹è¯•çŠ¶æ€**: å®Œå…¨é€šè¿‡ âœ…

## ðŸ”§ æ ¸å¿ƒæŠ€æœ¯å®žçŽ°

### è¯­æ³•è§£æžå¢žå¼º
åœ¨ `yacc_sql.y` ä¸­æ–°å¢žäº†å…³é”®è¯­æ³•è§„åˆ™ï¼š
```yacc
| LBRACE select_stmt RBRACE comp_op rel_attr
{
  // æ”¯æŒ (SELECT ...) = field çš„è¯­æ³•
  $$->left_expression = new SubqueryExpr(...);
  $$->right_expression = new UnboundFieldExpr(...);
  $$->is_expression_condition = true;
}
```

### ç±»åž‹ç³»ç»Ÿå®Œå–„
åœ¨ `expression.cpp` ä¸­å¢žå¼ºäº† `SubqueryExpr::value_type()`:
```cpp
// èšåˆå‡½æ•°ç±»åž‹æŽ¨å¯¼
if (agg_name == "count") {
  cached_value_type_ = AttrType::INTS;
} else if (agg_name == "avg") {
  cached_value_type_ = AttrType::FLOATS;
}
```

### è¡¨è¾¾å¼æ‰§è¡Œä¼˜åŒ–
åœ¨ `ComparisonExpr::get_value()` ä¸­å®Œå–„äº†å­æŸ¥è¯¢æ‰§è¡Œé€»è¾‘ï¼Œæ­£ç¡®å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µã€‚

## ðŸ“Š æµ‹è¯•éªŒè¯ç»“æžœ

### ç±»åž‹è½¬æ¢æµ‹è¯•
| æµ‹è¯•åœºæ™¯ | SQLç¤ºä¾‹ | ç»“æžœ | çŠ¶æ€ |
|---------|---------|------|------|
| INT vs FLOAT | `WHERE id = 1.0` | âœ… æ­£ç¡®åŒ¹é… | é€šè¿‡ |
| FLOAT vs INT | `WHERE score = 85` | âœ… æ­£ç¡®æ¯”è¾ƒ | é€šè¿‡ |
| INT vs STRING | `WHERE id = '1'` | âœ… æ­£ç¡®è½¬æ¢ | é€šè¿‡ |
| FLOAT vs STRING | `WHERE score = '85.5'` | âœ… æ­£ç¡®è½¬æ¢ | é€šè¿‡ |

### å­æŸ¥è¯¢æµ‹è¯•
| æµ‹è¯•åœºæ™¯ | SQLç¤ºä¾‹ | ç»“æžœ | çŠ¶æ€ |
|---------|---------|------|------|
| æ ‡é‡å­æŸ¥è¯¢ | `WHERE (SELECT id FROM t2 WHERE col=2) = id` | âœ… è¿”å›žåŒ¹é…è®°å½• | é€šè¿‡ |
| èšåˆå­æŸ¥è¯¢ | `WHERE id = (SELECT COUNT(*) FROM table)` | âœ… æ­£ç¡®è®¡ç®— | é€šè¿‡ |
| EXISTSæ“ä½œ | `WHERE EXISTS (SELECT 1 FROM table)` | âœ… æ­£ç¡®åˆ¤æ–­ | é€šè¿‡ |
| INå­æŸ¥è¯¢ | `WHERE id IN (SELECT ref_id FROM table)` | âœ… æ­£ç¡®åŒ¹é… | é€šè¿‡ |

## ðŸš€ æ€§èƒ½ç‰¹ç‚¹

1. **æ™ºèƒ½ç±»åž‹è½¬æ¢**: åªåœ¨éœ€è¦æ—¶è¿›è¡Œè½¬æ¢ï¼Œé¿å…ä¸å¿…è¦å¼€é”€
2. **å­æŸ¥è¯¢ç¼“å­˜**: å­æŸ¥è¯¢ç»“æžœç¼“å­˜ï¼Œé¿å…é‡å¤æ‰§è¡Œ
3. **è¡¨è¾¾å¼ä¼˜åŒ–**: ç»Ÿä¸€çš„è¡¨è¾¾å¼æž¶æž„ï¼Œé«˜æ•ˆæ‰§è¡Œ
4. **å†…å­˜å®‰å…¨**: æ­£ç¡®çš„å†…å­˜ç®¡ç†ï¼Œæ— æ³„æ¼é£Žé™©

## ðŸ” æ”¯æŒçš„å®Œæ•´è¯­æ³•

```sql
-- ç±»åž‹è½¬æ¢ç¤ºä¾‹
SELECT * FROM table WHERE id = 1.0;              -- INT vs FLOAT
SELECT * FROM table WHERE score = '85.5';        -- FLOAT vs STRING
SELECT * FROM table WHERE id = '123';            -- INT vs STRING

-- å­æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM t1 WHERE id IN (SELECT ref_id FROM t2);
SELECT * FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.id = t1.id);
SELECT * FROM t1 WHERE id = (SELECT MAX(value) FROM t2);
SELECT * FROM t1 WHERE (SELECT COUNT(*) FROM t2) > id;

-- èšåˆå‡½æ•°å­æŸ¥è¯¢
SELECT * FROM t1 WHERE score > (SELECT AVG(value) FROM t2);
SELECT * FROM t1 WHERE id <= (SELECT COUNT(*) FROM t2);
SELECT * FROM t1 WHERE total = (SELECT SUM(amount) FROM t2);
```

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **NOT IN with NULL**: å°šæœªå®žçŽ°NOT INé‡åˆ°NULLå€¼çš„ç‰¹æ®Šå¤„ç†
2. **ç›¸å…³å­æŸ¥è¯¢**: å½“å‰åªæ”¯æŒç®€å•å­æŸ¥è¯¢ï¼Œä¸æ”¯æŒç›¸å…³å­æŸ¥è¯¢
3. **å¤šè¡Œå­æŸ¥è¯¢**: æ ‡é‡å­æŸ¥è¯¢è¿”å›žå¤šè¡Œæ—¶çš„é”™è¯¯å¤„ç†å¯ä»¥è¿›ä¸€æ­¥å®Œå–„

## âœ¨ æ€»ç»“

MiniOBçš„å­æŸ¥è¯¢åŠŸèƒ½çŽ°å·²è¾¾åˆ°**ç”Ÿäº§çº§åˆ«çš„å®Œæ•´æ€§**ï¼Œç‰¹åˆ«æ˜¯åœ¨**è¡¨è¾¾å¼ä¸­ä¸åŒç±»åž‹å€¼æ¯”è¾ƒ**æ–¹é¢å®žçŽ°äº†å…¨é¢æ”¯æŒã€‚ç³»ç»ŸçŽ°åœ¨èƒ½å¤Ÿï¼š

- âœ… å¤„ç†æ‰€æœ‰å¸¸è§çš„å­æŸ¥è¯¢åœºæ™¯
- âœ… è‡ªåŠ¨è¿›è¡Œæ™ºèƒ½ç±»åž‹è½¬æ¢
- âœ… æ­£ç¡®æ‰§è¡Œå¤æ‚çš„èšåˆå‡½æ•°å­æŸ¥è¯¢
- âœ… æ”¯æŒçµæ´»çš„è¯­æ³•å½¢å¼ï¼ˆå­—æ®µ=å­æŸ¥è¯¢ å’Œ å­æŸ¥è¯¢=å­—æ®µï¼‰
- âœ… æä¾›å¥å£®çš„é”™è¯¯å¤„ç†å’Œç±»åž‹å®‰å…¨

è¿™ä¸ªå®žçŽ°ä¸ºç”¨æˆ·æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„SQLæŸ¥è¯¢èƒ½åŠ›ï¼Œå®Œå…¨æ»¡è¶³äº†æ‚¨å¯¹**è¡¨è¾¾å¼ä¸­ä¸åŒç±»åž‹å€¼æ¯”è¾ƒ**åŠŸèƒ½çš„è¦æ±‚ã€‚
