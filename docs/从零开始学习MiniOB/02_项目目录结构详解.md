# MiniOB项目目录结构详解

## 🎯 学习目标

通过分析项目目录结构，你将理解：
1. 大型C++项目的组织方式
2. 各个模块的职责划分
3. 代码的分层架构
4. 如何在项目中快速定位功能

## 📁 完整目录结构

### 1. 顶层目录结构
```
OBZen-zhanghao-2024/
├── src/                    # 源代码目录
│   ├── observer/          # 数据库服务器核心
│   ├── obclient/          # 数据库客户端
│   ├── common/            # 公共组件库
│   ├── oblsm/             # LSM存储引擎
│   ├── memtracer/         # 内存跟踪和调试工具
│   ├── cpplings/          # C++学习练习集
│   └── CMakeLists.txt     # src目录的构建配置
├── test/                  # 集成测试
├── unittest/              # 单元测试
├── docs/                  # 文档
├── benchmark/             # 性能测试
├── tools/                 # 工具脚本
├── build.sh              # 编译脚本
└── CMakeLists.txt         # 构建配置
```

### 2. 核心服务器目录 (src/observer/)
```
src/observer/
├── main.cpp              # 程序入口 ⭐
├── catalog/              # 元数据管理
├── common/               # 服务器公共组件
├── event/                # 事件处理
├── net/                  # 网络通信层
├── session/              # 会话管理
├── sql/                  # SQL处理层 ⭐⭐⭐
└── storage/              # 存储引擎 ⭐⭐⭐
```

## 🔍 核心模块详解

### 1. SQL处理层 (src/observer/sql/) ⭐⭐⭐

这是数据库的"大脑"，负责理解和执行SQL语句：

```
sql/
├── executor/             # 执行器 - 真正执行查询
│   ├── execute_stage.cpp # 执行阶段管理
│   ├── sql_result.h      # SQL执行结果
│   └── ...
├── expr/                 # 表达式系统 - 计算各种表达式
│   ├── expression.h      # 表达式基类 ⭐
│   ├── expression.cpp    # 表达式实现
│   ├── tuple.h           # 数据行抽象
│   └── ...
├── operator/             # 算子 - 查询执行的基本单元
│   ├── logical_operator.h    # 逻辑算子基类
│   ├── physical_operator.h   # 物理算子基类
│   ├── table_scan_*.cpp      # 表扫描算子
│   ├── project_*.cpp         # 投影算子
│   └── ...
├── optimizer/            # 查询优化器 - 优化查询计划
│   ├── logical_plan_generator.cpp  # 逻辑计划生成
│   ├── physical_plan_generator.cpp # 物理计划生成
│   ├── rewriter.cpp              # 查询重写
│   └── ...
├── parser/               # SQL解析器 - 将SQL文本转为内部表示
│   ├── parse.cpp         # 解析入口
│   ├── yacc_sql.y        # 语法规则文件 ⭐
│   ├── lex_sql.l         # 词法规则文件 ⭐
│   └── ...
├── stmt/                 # SQL语句 - 解析后的SQL表示
│   ├── select_stmt.cpp   # SELECT语句
│   ├── insert_stmt.cpp   # INSERT语句
│   ├── update_stmt.cpp   # UPDATE语句
│   └── ...
├── plan_cache/           # 计划缓存
└── query_cache/          # 查询缓存
```

#### SQL处理流程
```
SQL文本 → Parser → Stmt → Optimizer → Operator → Executor → 结果
  ↓         ↓       ↓        ↓          ↓         ↓       ↓
"SELECT   语法树   语句对象   优化计划    执行算子   执行器   结果集
 * FROM             
 users"
```

### 2. 存储引擎 (src/observer/storage/) ⭐⭐⭐

这是数据库的"心脏"，负责数据的存储和管理：

```
storage/
├── buffer/               # 缓冲池管理 - 内存中的数据页缓存
│   ├── buffer_pool_manager.h  # 缓冲池管理器
│   ├── page.h               # 内存页抽象
│   └── ...
├── db/                   # 数据库管理
│   ├── db.h              # 数据库类 ⭐
│   ├── db.cpp            # 数据库实现
│   └── ...
├── table/                # 表管理
│   ├── table.h           # 表类 ⭐
│   ├── table.cpp         # 表实现
│   ├── table_meta.h      # 表元数据
│   └── ...
├── record/               # 记录管理 - 数据行的存储
│   ├── record_manager.h  # 记录管理器
│   ├── record.h          # 记录抽象
│   └── ...
├── index/                # 索引管理 - 快速数据检索
│   ├── index.h           # 索引接口
│   ├── bplus_tree.h      # B+树索引 ⭐
│   └── ...
├── field/                # 字段管理
│   ├── field.h           # 字段类
│   ├── field_meta.h      # 字段元数据
│   └── ...
├── common/               # 存储公共组件
│   ├── meta_util.h       # 元数据工具
│   ├── chunk.h           # 数据块（向量化）
│   └── ...
├── trx/                  # 事务管理
│   ├── trx.h             # 事务抽象
│   └── ...
├── clog/                 # 提交日志
├── persist/              # 持久化
└── default/              # 默认存储实现
```

#### 存储层次结构
```
数据库 (Database)
    ↓
表 (Table)
    ↓
记录 (Record/Row)
    ↓
字段 (Field/Column)
    ↓
页 (Page)
    ↓
磁盘文件
```

### 3. 网络通信层 (src/observer/net/)

负责与客户端的通信：

```
net/
├── server.h              # 服务器类 ⭐
├── server.cpp            # 服务器实现
├── communicator.h        # 通信器接口
├── plain_communicator.cpp # 普通协议通信
├── mysql_communicator.cpp # MySQL协议通信
└── ...
```

### 4. 会话管理 (src/observer/session/)

管理客户端连接和会话状态：

```
session/
├── session.h             # 会话类
├── session.cpp           # 会话实现
├── session_stage.cpp     # 会话处理阶段
└── ...
```

### 5. 元数据管理 (src/observer/catalog/)

管理数据库、表、字段等元数据信息：

```
catalog/
├── catalog.h             # 目录管理器
├── catalog.cpp           # 目录实现
└── ...
```

### 6. 公共组件库 (src/common/) ⭐⭐

为整个项目提供基础设施和工具函数：

```
common/
├── conf/                 # 配置文件解析
├── lang/                 # 语言特性封装 (string, mutex等)
├── log/                  # 日志系统
├── os/                   # 操作系统相关 (进程, 信号等)
├── sys/                  # 系统工具 (RC返回码等)
└── ...
```

### 7. 内存跟踪器 (src/memtracer/) 🔧

**可选的调试和分析工具**，用于监控MiniOB的内存使用：

```
memtracer/
├── memtracer.h           # 内存跟踪器主类
├── allocator.h           # 内存分配器
├── common.h              # 公共定义
└── mt_info.h             # 内存跟踪信息
```

**主要功能：**
- 🔍 内存使用监控和统计
- 🐛 内存泄漏检测  
- 📊 内存分配/释放跟踪
- 🎯 内存受限环境测试

### 8. C++学习练习 (src/cpplings/) 📚

**学习辅助工具**，包含MiniOB开发相关的C++练习：

```
cpplings/
├── smart_pointer.cpp     # 智能指针练习
├── stl.cpp              # STL容器和算法
├── template.cpp         # 模板编程
├── mutex.cpp            # 互斥锁和线程安全
├── condition_variable.cpp # 条件变量
├── lambda.cpp           # Lambda表达式
├── cas.cpp              # 原子操作和CAS
└── lock.cpp             # 锁机制
```

**学习目标：**
- 🎯 掌握MiniOB开发所需的C++技能
- 💡 通过实践练习理解核心概念
- 🏆 完成TODO任务获得"passed!"验证

### 9. 构建配置 (src/CMakeLists.txt) ⚙️

控制整个src目录的模块化构建：

```cmake
ADD_SUBDIRECTORY(common)     # 基础库
ADD_SUBDIRECTORY(observer)   # 数据库主程序  
ADD_SUBDIRECTORY(obclient)   # 客户端
ADD_SUBDIRECTORY(oblsm)      # LSM存储引擎

# 可选组件 - 条件编译
if (WITH_CPPLINGS)
    ADD_SUBDIRECTORY(cpplings)
endif()

if (WITH_MEMTRACER)  
    ADD_SUBDIRECTORY(memtracer)
endif()
```

## 🎓 C++项目组织的最佳实践

### 1. 头文件和源文件分离
```cpp
// 头文件 (.h) - 声明
class Table {
public:
    RC insert_record(Record& record);  // 只有声明
private:
    string name_;
};

// 源文件 (.cpp) - 实现
RC Table::insert_record(Record& record) {
    // 具体实现代码
    return RC::SUCCESS;
}
```

**好处：**
- 编译速度快（头文件变化时不需要重新编译所有依赖文件）
- 接口清晰（头文件展示类的公共接口）
- 减少编译依赖

### 2. 目录按功能模块组织
```
按功能分组，而不是按文件类型：

✅ 好的组织方式：
sql/
├── parser/     # 解析相关的所有文件
├── optimizer/  # 优化相关的所有文件
└── executor/   # 执行相关的所有文件

❌ 不好的组织方式：
src/
├── headers/    # 所有头文件混在一起
├── sources/    # 所有源文件混在一起
└── tests/      # 所有测试混在一起
```

### 3. 命名约定
```cpp
// 文件命名：小写+下划线
table_manager.h
table_manager.cpp

// 类命名：大驼峰
class TableManager {
    
// 函数命名：小写+下划线  
public:
    RC insert_record();
    
// 成员变量：小写+下划线+后缀
private:
    string table_name_;
    int record_count_;
};
```

## 🔍 如何在项目中导航

### 1. 按功能查找
```
想了解SQL解析？      → src/observer/sql/parser/
想了解表管理？       → src/observer/storage/table/
想了解索引实现？     → src/observer/storage/index/
想了解网络通信？     → src/observer/net/
```

### 2. 按文件类型查找
```
看接口定义？         → 找 .h 文件
看具体实现？         → 找 .cpp 文件
看测试用例？         → 找 unittest/ 或 test/
看配置示例？         → 找 etc/ 目录
```

### 3. 重要文件优先级

**⭐⭐⭐ 核心必看：**
- `src/observer/main.cpp` - 程序入口
- `src/observer/sql/expr/expression.h` - 表达式系统
- `src/observer/storage/table/table.h` - 表管理
- `src/observer/storage/db/db.h` - 数据库管理

**⭐⭐ 重要理解：**
- `src/observer/sql/parser/yacc_sql.y` - SQL语法规则
- `src/observer/storage/index/bplus_tree.h` - B+树索引
- `src/observer/net/server.h` - 网络服务器

**⭐ 深入学习：**
- `src/observer/sql/optimizer/` - 查询优化器
- `src/observer/storage/trx/` - 事务管理
- `src/observer/storage/buffer/` - 缓冲池管理

## 🚀 学习路径建议

### 阶段0：C++技能准备 (可选，1-2周)
**如果C++基础薄弱，强烈建议先完成：**
1. 📚 完成 `src/cpplings/` 中的练习
2. 🎯 重点关注：智能指针、STL、模板、线程同步
3. 💡 每个练习都要达到"passed!"状态

### 阶段1：理解整体架构 (1周)
1. 阅读 `main.cpp` 理解启动流程
2. 浏览各目录，理解模块划分
3. 看几个关键头文件的接口定义
4. 🔧 了解 `src/memtracer/` 的调试功能（可选）

### 阶段2：存储引擎 (2-3周)
1. `storage/db/` - 数据库管理
2. `storage/table/` - 表管理  
3. `storage/record/` - 记录管理
4. `storage/index/` - 索引管理

### 阶段3：SQL处理 (3-4周)
1. `sql/parser/` - SQL解析
2. `sql/expr/` - 表达式系统（已学过）
3. `sql/stmt/` - SQL语句表示
4. `sql/executor/` - 查询执行

### 阶段4：高级特性 (2-3周)
1. `sql/optimizer/` - 查询优化
2. `storage/trx/` - 事务处理
3. `net/` - 网络通信
4. `session/` - 会话管理

## 💡 学习技巧

1. **自顶向下：** 先理解整体架构，再深入细节
2. **跟踪数据流：** 一个SQL查询是如何一步步处理的
3. **看测试用例：** unittest/ 目录有很多使用示例
4. **画架构图：** 把模块关系画出来加深理解
5. **动手实践：** 修改代码，看看会发生什么
6. **📚 先练后学：** C++基础薄弱时，先完成cpplings练习
7. **🔧 调试技能：** 学会使用memtracer分析内存问题
8. **📖 循序渐进：** 按阶段学习，不要跳跃太大

现在你对项目结构有了整体认识，准备深入学习某个具体模块了吗？
