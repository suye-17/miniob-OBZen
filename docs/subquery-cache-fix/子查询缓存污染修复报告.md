# MiniOB 子查询缓存污染Bug修复报告

**文档版本**: v2.0  
**创建日期**: 2025-10-18  
**最后更新**: 2025-10-18  
**修复状态**: ✅ 已完成并推送（两轮修复）  
**Git Commits**: 530f9c2 (第一轮), 当前提交 (第二轮)

---

## 修复位置汇总

| # | 类 | 文件 | 行号 | 问题类型 | 修复方式 |
|---|---|------|------|---------|---------|
| 1 | InExpr | expression.cpp | 1455-1456 | static executor | 改为局部变量 |
| 2 | ExistsExpr | expression.cpp | 1630-1631 | static executor | 改为局部变量 |
| 3 | ComparisonExpr | expression.cpp | 709-710 | static executor | 改为局部变量 |
| 4 | ComparisonExpr | expression.cpp | 738-739 | static executor | 改为局部变量 |
| 5 | SubqueryExpr | expression.cpp | 1365-1366 | static executor | 改为局部变量 |
| 6 | ComparisonExpr | expression.cpp | 666-670 | 缓存检查 | 移除逻辑 |
| 7 | ComparisonExpr | expression.cpp | 693-700 | 缓存保存 | 移除逻辑 |
| 8 | ComparisonExpr | expression.cpp | 707-713 | 缓存保存 | 移除逻辑 |
| 9 | ComparisonExpr | expression.cpp | 745-746 | 缓存清理方法 | 注释掉 |
| 10 | ComparisonExpr | expression.cpp | 767-768 | 递归缓存清理 | 注释掉 |
| 11 | ComparisonExpr | expression.h | 419-420 | 方法声明 | 注释掉 |
| 12 | ComparisonExpr | expression.h | 427-428 | 方法声明 | 注释掉 |
| 13 | ComparisonExpr | expression.h | 459-461 | mutable 变量 | 注释掉 |
| 14 | SubqueryExpr | expression.cpp | 1243-1300 | 类型缓存 | 移除逻辑 |
| 15 | SubqueryExpr | expression.cpp | 1353-1357 | 缓存清理 | 移除逻辑 |
| 16 | SubqueryExpr | expression.h | 719-721 | mutable 变量 | 注释掉 |
| 17 | SubqueryExecutor | subquery_executor.cpp | 24-26 | 实例级缓存 | 禁用缓存 |

**共计**: 17 处修复

---

## 代码更改详情

### 修复1: InExpr - 移除 static executor

**文件**: `src/observer/sql/expr/expression.cpp:1455-1456`

```cpp
// ❌ 修复前
static SubqueryExecutor executor;
rc = executor.execute_subquery(subquery_expr->subquery(), session_, results);

// ✅ 修复后
// 🔧 修复：移除static避免缓存污染，每次创建新实例
SubqueryExecutor executor;
rc = executor.execute_subquery(subquery_expr->subquery(), session_, results);
```

---

### 修复2: ExistsExpr - 移除 static executor

**文件**: `src/observer/sql/expr/expression.cpp:1630-1631`

```cpp
// ❌ 修复前
static SubqueryExecutor executor;

// ✅ 修复后
// 🔧 修复：移除static避免缓存污染
SubqueryExecutor executor;
```

---

### 修复3: ComparisonExpr (复杂子查询) - 移除 static executor

**文件**: `src/observer/sql/expr/expression.cpp:709-710`

```cpp
// ❌ 修复前
static SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);

// ✅ 修复后
// 🔧 修复：移除static避免缓存污染
SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);
```

---

### 修复4: ComparisonExpr (简单子查询) - 移除 static executor

**文件**: `src/observer/sql/expr/expression.cpp:738-739`

```cpp
// ❌ 修复前
static SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);

// ✅ 修复后
// 🔧 修复：移除static避免缓存污染
SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);
```

---

### 修复5: SubqueryExpr - 移除 static executor

**文件**: `src/observer/sql/expr/expression.cpp:1365-1366`

```cpp
// ❌ 修复前
static SubqueryExecutor executor;
RC rc = executor.execute_subquery(subquery_.get(), session_, results);

// ✅ 修复后
// 🔧 修复：移除static避免缓存污染
SubqueryExecutor executor;
RC rc = executor.execute_subquery(subquery_.get(), session_, results);
```

---

### 修复6: ComparisonExpr - 移除缓存检查

**文件**: `src/observer/sql/expr/expression.cpp:666-670`

```cpp
// ❌ 修复前
if (cache_valid_) {
  results = subquery_cache_;
  LOG_DEBUG("Using cached subquery results, returned %zu values", results.size());
  return RC::SUCCESS;
}
LOG_DEBUG("Executing subquery (no cache available)");

// ✅ 修复后
// 🔧 修复：移除 mutable 缓存检查，避免跨 Tuple 的状态污染
LOG_DEBUG("Executing subquery (always fresh execution)");
```

---

### 修复7: ComparisonExpr - 移除缓存保存（简单子查询）

**文件**: `src/observer/sql/expr/expression.cpp:693-700`

```cpp
// ❌ 修复前
RC rc = execute_simple_subquery(select_node, results);
if (rc == RC::SUCCESS) {
  // 缓存结果
  subquery_cache_ = results;
  cache_valid_ = true;
  LOG_DEBUG("Simple subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}

// ✅ 修复后
RC rc = execute_simple_subquery(select_node, results);
if (rc == RC::SUCCESS) {
  LOG_DEBUG("Simple subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}
```

---

### 修复8: ComparisonExpr - 移除缓存保存（复杂子查询）

**文件**: `src/observer/sql/expr/expression.cpp:707-713`

```cpp
// ❌ 修复前
RC rc = executor.execute_subquery(select_node, session_, results);
if (rc == RC::SUCCESS) {
  // 缓存结果
  subquery_cache_ = results;
  cache_valid_ = true;
  LOG_DEBUG("Complex subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}

// ✅ 修复后
RC rc = executor.execute_subquery(select_node, session_, results);
if (rc == RC::SUCCESS) {
  LOG_DEBUG("Complex subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}
```

---

### 修复9-10: ComparisonExpr - 移除缓存管理方法

**文件**: `src/observer/sql/expr/expression.cpp:745-746, 767-768`

```cpp
// ❌ 修复前
void ComparisonExpr::clear_subquery_cache() const
{
  subquery_cache_.clear();
  cache_valid_ = false;
  LOG_DEBUG("Subquery cache cleared");
}

void ComparisonExpr::clear_subquery_cache_recursive()
{
  if (has_subquery_) {
    clear_subquery_cache();
    LOG_DEBUG("Cleared subquery cache for ComparisonExpr");
  }
  if (left_) {
    left_->clear_subquery_cache_recursive();
  }
  if (right_) {
    right_->clear_subquery_cache_recursive();
  }
}

// ✅ 修复后
// 🔧 修复：移除缓存清理方法，已不再需要
// void ComparisonExpr::clear_subquery_cache() const { ... }
// void ComparisonExpr::clear_subquery_cache_recursive() { ... }
```

---

### 修复11-12: ComparisonExpr 头文件 - 移除方法声明

**文件**: `src/observer/sql/expr/expression.h:419-420, 427-428`

```cpp
// ❌ 修复前
void clear_subquery_cache() const;
void clear_subquery_cache_recursive() override;

// ✅ 修复后
// 🔧 修复：移除缓存管理方法声明
// void clear_subquery_cache() const;
// void clear_subquery_cache_recursive() override;
```

---

### 修复13: ComparisonExpr 头文件 - 移除 mutable 缓存变量

**文件**: `src/observer/sql/expr/expression.h:459-461`

```cpp
// ❌ 修复前
mutable vector<Value>    subquery_cache_;
mutable bool             cache_valid_ = false;

// ✅ 修复后
// 🔧 修复：移除 mutable 缓存变量，避免跨查询的状态污染
// mutable vector<Value>    subquery_cache_;
// mutable bool             cache_valid_ = false;
```

---

### 修复14: SubqueryExpr - 移除类型缓存逻辑

**文件**: `src/observer/sql/expr/expression.cpp:1243-1300`

```cpp
// ❌ 修复前
AttrType SubqueryExpr::value_type() const
{
  if (type_cached_) {
    return cached_value_type_;
  }
  
  // ... 计算类型 ...
  
  cached_value_type_ = result_type;
  type_cached_ = true;
  return cached_value_type_;
}

// ✅ 修复后
AttrType SubqueryExpr::value_type() const
{
  // 🔧 修复：移除缓存逻辑，每次重新计算类型
  
  // ... 计算类型 ...
  
  return result_type;  // 直接返回，不缓存
}
```

---

### 修复15: SubqueryExpr - 移除缓存清理

**文件**: `src/observer/sql/expr/expression.cpp:1353-1357`

```cpp
// ❌ 修复前
void SubqueryExpr::set_session_context_recursive(class Session *session)
{
  session_ = session;
  type_cached_ = false;
}

// ✅ 修复后
void SubqueryExpr::set_session_context_recursive(class Session *session)
{
  session_ = session;
  // 🔧 修复：移除缓存清理逻辑
}
```

---

### 修复16: SubqueryExpr 头文件 - 移除 mutable 缓存变量

**文件**: `src/observer/sql/expr/expression.h:719-721`

```cpp
// ❌ 修复前
mutable AttrType cached_value_type_ = AttrType::UNDEFINED;
mutable bool     type_cached_ = false;

// ✅ 修复后
// 🔧 修复：移除 mutable 缓存变量，避免跨查询的状态污染
// mutable AttrType cached_value_type_ = AttrType::UNDEFINED;
// mutable bool     type_cached_ = false;
```

---

### 修复17: SubqueryExecutor - 禁用实例级缓存（第二轮）

**文件**: `src/observer/sql/expr/subquery_executor.cpp:24-26`

```cpp
// ❌ 修复前
SubqueryExecutor::SubqueryExecutor() 
    : cache_limit_(1000), cache_enabled_(true), cache_hits_(0), cache_misses_(0), total_executions_(0)
{
}

// ✅ 修复后
SubqueryExecutor::SubqueryExecutor() 
    : cache_limit_(1000), cache_enabled_(false), cache_hits_(0), cache_misses_(0), total_executions_(0)
{
  // 🔧 修复：禁用实例级缓存，避免缓存键设计缺陷
  // 由于每次都创建新的 SubqueryExecutor 实例，实例级缓存价值有限
  // 缓存键只基于 SQL 结构，不包含数据内容，可能导致错误结果
}
```

---

## Git 提交信息

### 第一轮修复 (Commit: 530f9c2)

```
fix: 修复子查询缓存污染问题

核心修复:
1. 移除 InExpr 中的 static SubqueryExecutor (expression.cpp:1456)
2. 移除 ExistsExpr 中的 static SubqueryExecutor (expression.cpp:1631)
3. 移除 ComparisonExpr 中的 static SubqueryExecutor (expression.cpp:710, 739)
4. 移除 SubqueryExpr 中的 static SubqueryExecutor (expression.cpp:1366)
5. 移除 ComparisonExpr 的 mutable 缓存变量 (expression.h:460-461)
6. 移除 SubqueryExpr 的 mutable 缓存变量 (expression.h:720-721)
7. 移除相关缓存清理方法

问题描述:
- static SubqueryExecutor 导致跨查询共享缓存
- mutable 缓存变量导致跨 Tuple 的状态污染
- 相同SQL在不同数据下返回错误的旧结果

解决方案:
- 每次创建新的 SubqueryExecutor 实例
- 移除所有 mutable 缓存机制
- 确保每次查询都重新执行，保证数据正确性
```

### 第二轮修复 (待推送)

```
fix: 禁用 SubqueryExecutor 实例级缓存

核心修复:
- 将 cache_enabled_ 从 true 改为 false (subquery_executor.cpp:25)

问题描述:
- 虽然移除了 static SubqueryExecutor，但实例内部仍有缓存
- 缓存键只基于 SQL 结构，不包含数据内容
- 可能导致单个实例内多次调用时的缓存污染

解决方案:
- 完全禁用 SubqueryExecutor 的实例级缓存
- 防御性编程，确保零缓存污染风险
- 由于实例生命周期短，实例级缓存价值有限
```

---

**文档结束** - 2025-10-18
