# MiniOB å­æŸ¥è¯¢ç¼“å­˜æ±¡æŸ“Bugä¿®å¤æŠ¥å‘Š

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-18  
**æœ€åæ›´æ–°**: 2025-10-18  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æ¨é€ï¼ˆä¸¤è½®ä¿®å¤ï¼‰  
**Git Commits**: 530f9c2 (ç¬¬ä¸€è½®), å½“å‰æäº¤ (ç¬¬äºŒè½®)

---

## ä¿®å¤ä½ç½®æ±‡æ€»

| # | ç±» | æ–‡ä»¶ | è¡Œå· | é—®é¢˜ç±»å‹ | ä¿®å¤æ–¹å¼ |
|---|---|------|------|---------|---------|
| 1 | InExpr | expression.cpp | 1455-1456 | static executor | æ”¹ä¸ºå±€éƒ¨å˜é‡ |
| 2 | ExistsExpr | expression.cpp | 1630-1631 | static executor | æ”¹ä¸ºå±€éƒ¨å˜é‡ |
| 3 | ComparisonExpr | expression.cpp | 709-710 | static executor | æ”¹ä¸ºå±€éƒ¨å˜é‡ |
| 4 | ComparisonExpr | expression.cpp | 738-739 | static executor | æ”¹ä¸ºå±€éƒ¨å˜é‡ |
| 5 | SubqueryExpr | expression.cpp | 1365-1366 | static executor | æ”¹ä¸ºå±€éƒ¨å˜é‡ |
| 6 | ComparisonExpr | expression.cpp | 666-670 | ç¼“å­˜æ£€æŸ¥ | ç§»é™¤é€»è¾‘ |
| 7 | ComparisonExpr | expression.cpp | 693-700 | ç¼“å­˜ä¿å­˜ | ç§»é™¤é€»è¾‘ |
| 8 | ComparisonExpr | expression.cpp | 707-713 | ç¼“å­˜ä¿å­˜ | ç§»é™¤é€»è¾‘ |
| 9 | ComparisonExpr | expression.cpp | 745-746 | ç¼“å­˜æ¸…ç†æ–¹æ³• | æ³¨é‡Šæ‰ |
| 10 | ComparisonExpr | expression.cpp | 767-768 | é€’å½’ç¼“å­˜æ¸…ç† | æ³¨é‡Šæ‰ |
| 11 | ComparisonExpr | expression.h | 419-420 | æ–¹æ³•å£°æ˜ | æ³¨é‡Šæ‰ |
| 12 | ComparisonExpr | expression.h | 427-428 | æ–¹æ³•å£°æ˜ | æ³¨é‡Šæ‰ |
| 13 | ComparisonExpr | expression.h | 459-461 | mutable å˜é‡ | æ³¨é‡Šæ‰ |
| 14 | SubqueryExpr | expression.cpp | 1243-1300 | ç±»å‹ç¼“å­˜ | ç§»é™¤é€»è¾‘ |
| 15 | SubqueryExpr | expression.cpp | 1353-1357 | ç¼“å­˜æ¸…ç† | ç§»é™¤é€»è¾‘ |
| 16 | SubqueryExpr | expression.h | 719-721 | mutable å˜é‡ | æ³¨é‡Šæ‰ |
| 17 | SubqueryExecutor | subquery_executor.cpp | 24-26 | å®ä¾‹çº§ç¼“å­˜ | ç¦ç”¨ç¼“å­˜ |

**å…±è®¡**: 17 å¤„ä¿®å¤

---

## ä»£ç æ›´æ”¹è¯¦æƒ…

### ä¿®å¤1: InExpr - ç§»é™¤ static executor

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:1455-1456`

```cpp
// âŒ ä¿®å¤å‰
static SubqueryExecutor executor;
rc = executor.execute_subquery(subquery_expr->subquery(), session_, results);

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤staticé¿å…ç¼“å­˜æ±¡æŸ“ï¼Œæ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹
SubqueryExecutor executor;
rc = executor.execute_subquery(subquery_expr->subquery(), session_, results);
```

---

### ä¿®å¤2: ExistsExpr - ç§»é™¤ static executor

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:1630-1631`

```cpp
// âŒ ä¿®å¤å‰
static SubqueryExecutor executor;

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤staticé¿å…ç¼“å­˜æ±¡æŸ“
SubqueryExecutor executor;
```

---

### ä¿®å¤3: ComparisonExpr (å¤æ‚å­æŸ¥è¯¢) - ç§»é™¤ static executor

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:709-710`

```cpp
// âŒ ä¿®å¤å‰
static SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤staticé¿å…ç¼“å­˜æ±¡æŸ“
SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);
```

---

### ä¿®å¤4: ComparisonExpr (ç®€å•å­æŸ¥è¯¢) - ç§»é™¤ static executor

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:738-739`

```cpp
// âŒ ä¿®å¤å‰
static SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤staticé¿å…ç¼“å­˜æ±¡æŸ“
SubqueryExecutor executor;
RC rc = executor.execute_subquery(select_node, session_, results);
```

---

### ä¿®å¤5: SubqueryExpr - ç§»é™¤ static executor

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:1365-1366`

```cpp
// âŒ ä¿®å¤å‰
static SubqueryExecutor executor;
RC rc = executor.execute_subquery(subquery_.get(), session_, results);

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤staticé¿å…ç¼“å­˜æ±¡æŸ“
SubqueryExecutor executor;
RC rc = executor.execute_subquery(subquery_.get(), session_, results);
```

---

### ä¿®å¤6: ComparisonExpr - ç§»é™¤ç¼“å­˜æ£€æŸ¥

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:666-670`

```cpp
// âŒ ä¿®å¤å‰
if (cache_valid_) {
  results = subquery_cache_;
  LOG_DEBUG("Using cached subquery results, returned %zu values", results.size());
  return RC::SUCCESS;
}
LOG_DEBUG("Executing subquery (no cache available)");

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤ mutable ç¼“å­˜æ£€æŸ¥ï¼Œé¿å…è·¨ Tuple çš„çŠ¶æ€æ±¡æŸ“
LOG_DEBUG("Executing subquery (always fresh execution)");
```

---

### ä¿®å¤7: ComparisonExpr - ç§»é™¤ç¼“å­˜ä¿å­˜ï¼ˆç®€å•å­æŸ¥è¯¢ï¼‰

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:693-700`

```cpp
// âŒ ä¿®å¤å‰
RC rc = execute_simple_subquery(select_node, results);
if (rc == RC::SUCCESS) {
  // ç¼“å­˜ç»“æœ
  subquery_cache_ = results;
  cache_valid_ = true;
  LOG_DEBUG("Simple subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}

// âœ… ä¿®å¤å
RC rc = execute_simple_subquery(select_node, results);
if (rc == RC::SUCCESS) {
  LOG_DEBUG("Simple subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}
```

---

### ä¿®å¤8: ComparisonExpr - ç§»é™¤ç¼“å­˜ä¿å­˜ï¼ˆå¤æ‚å­æŸ¥è¯¢ï¼‰

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:707-713`

```cpp
// âŒ ä¿®å¤å‰
RC rc = executor.execute_subquery(select_node, session_, results);
if (rc == RC::SUCCESS) {
  // ç¼“å­˜ç»“æœ
  subquery_cache_ = results;
  cache_valid_ = true;
  LOG_DEBUG("Complex subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}

// âœ… ä¿®å¤å
RC rc = executor.execute_subquery(select_node, session_, results);
if (rc == RC::SUCCESS) {
  LOG_DEBUG("Complex subquery executed successfully, returned %zu values", results.size());
  return RC::SUCCESS;
}
```

---

### ä¿®å¤9-10: ComparisonExpr - ç§»é™¤ç¼“å­˜ç®¡ç†æ–¹æ³•

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:745-746, 767-768`

```cpp
// âŒ ä¿®å¤å‰
void ComparisonExpr::clear_subquery_cache() const
{
  subquery_cache_.clear();
  cache_valid_ = false;
  LOG_DEBUG("Subquery cache cleared");
}

void ComparisonExpr::clear_subquery_cache_recursive()
{
  if (has_subquery_) {
    clear_subquery_cache();
    LOG_DEBUG("Cleared subquery cache for ComparisonExpr");
  }
  if (left_) {
    left_->clear_subquery_cache_recursive();
  }
  if (right_) {
    right_->clear_subquery_cache_recursive();
  }
}

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤ç¼“å­˜æ¸…ç†æ–¹æ³•ï¼Œå·²ä¸å†éœ€è¦
// void ComparisonExpr::clear_subquery_cache() const { ... }
// void ComparisonExpr::clear_subquery_cache_recursive() { ... }
```

---

### ä¿®å¤11-12: ComparisonExpr å¤´æ–‡ä»¶ - ç§»é™¤æ–¹æ³•å£°æ˜

**æ–‡ä»¶**: `src/observer/sql/expr/expression.h:419-420, 427-428`

```cpp
// âŒ ä¿®å¤å‰
void clear_subquery_cache() const;
void clear_subquery_cache_recursive() override;

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤ç¼“å­˜ç®¡ç†æ–¹æ³•å£°æ˜
// void clear_subquery_cache() const;
// void clear_subquery_cache_recursive() override;
```

---

### ä¿®å¤13: ComparisonExpr å¤´æ–‡ä»¶ - ç§»é™¤ mutable ç¼“å­˜å˜é‡

**æ–‡ä»¶**: `src/observer/sql/expr/expression.h:459-461`

```cpp
// âŒ ä¿®å¤å‰
mutable vector<Value>    subquery_cache_;
mutable bool             cache_valid_ = false;

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤ mutable ç¼“å­˜å˜é‡ï¼Œé¿å…è·¨æŸ¥è¯¢çš„çŠ¶æ€æ±¡æŸ“
// mutable vector<Value>    subquery_cache_;
// mutable bool             cache_valid_ = false;
```

---

### ä¿®å¤14: SubqueryExpr - ç§»é™¤ç±»å‹ç¼“å­˜é€»è¾‘

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:1243-1300`

```cpp
// âŒ ä¿®å¤å‰
AttrType SubqueryExpr::value_type() const
{
  if (type_cached_) {
    return cached_value_type_;
  }
  
  // ... è®¡ç®—ç±»å‹ ...
  
  cached_value_type_ = result_type;
  type_cached_ = true;
  return cached_value_type_;
}

// âœ… ä¿®å¤å
AttrType SubqueryExpr::value_type() const
{
  // ğŸ”§ ä¿®å¤ï¼šç§»é™¤ç¼“å­˜é€»è¾‘ï¼Œæ¯æ¬¡é‡æ–°è®¡ç®—ç±»å‹
  
  // ... è®¡ç®—ç±»å‹ ...
  
  return result_type;  // ç›´æ¥è¿”å›ï¼Œä¸ç¼“å­˜
}
```

---

### ä¿®å¤15: SubqueryExpr - ç§»é™¤ç¼“å­˜æ¸…ç†

**æ–‡ä»¶**: `src/observer/sql/expr/expression.cpp:1353-1357`

```cpp
// âŒ ä¿®å¤å‰
void SubqueryExpr::set_session_context_recursive(class Session *session)
{
  session_ = session;
  type_cached_ = false;
}

// âœ… ä¿®å¤å
void SubqueryExpr::set_session_context_recursive(class Session *session)
{
  session_ = session;
  // ğŸ”§ ä¿®å¤ï¼šç§»é™¤ç¼“å­˜æ¸…ç†é€»è¾‘
}
```

---

### ä¿®å¤16: SubqueryExpr å¤´æ–‡ä»¶ - ç§»é™¤ mutable ç¼“å­˜å˜é‡

**æ–‡ä»¶**: `src/observer/sql/expr/expression.h:719-721`

```cpp
// âŒ ä¿®å¤å‰
mutable AttrType cached_value_type_ = AttrType::UNDEFINED;
mutable bool     type_cached_ = false;

// âœ… ä¿®å¤å
// ğŸ”§ ä¿®å¤ï¼šç§»é™¤ mutable ç¼“å­˜å˜é‡ï¼Œé¿å…è·¨æŸ¥è¯¢çš„çŠ¶æ€æ±¡æŸ“
// mutable AttrType cached_value_type_ = AttrType::UNDEFINED;
// mutable bool     type_cached_ = false;
```

---

### ä¿®å¤17: SubqueryExecutor - ç¦ç”¨å®ä¾‹çº§ç¼“å­˜ï¼ˆç¬¬äºŒè½®ï¼‰

**æ–‡ä»¶**: `src/observer/sql/expr/subquery_executor.cpp:24-26`

```cpp
// âŒ ä¿®å¤å‰
SubqueryExecutor::SubqueryExecutor() 
    : cache_limit_(1000), cache_enabled_(true), cache_hits_(0), cache_misses_(0), total_executions_(0)
{
}

// âœ… ä¿®å¤å
SubqueryExecutor::SubqueryExecutor() 
    : cache_limit_(1000), cache_enabled_(false), cache_hits_(0), cache_misses_(0), total_executions_(0)
{
  // ğŸ”§ ä¿®å¤ï¼šç¦ç”¨å®ä¾‹çº§ç¼“å­˜ï¼Œé¿å…ç¼“å­˜é”®è®¾è®¡ç¼ºé™·
  // ç”±äºæ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„ SubqueryExecutor å®ä¾‹ï¼Œå®ä¾‹çº§ç¼“å­˜ä»·å€¼æœ‰é™
  // ç¼“å­˜é”®åªåŸºäº SQL ç»“æ„ï¼Œä¸åŒ…å«æ•°æ®å†…å®¹ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯ç»“æœ
}
```

---

## Git æäº¤ä¿¡æ¯

### ç¬¬ä¸€è½®ä¿®å¤ (Commit: 530f9c2)

```
fix: ä¿®å¤å­æŸ¥è¯¢ç¼“å­˜æ±¡æŸ“é—®é¢˜

æ ¸å¿ƒä¿®å¤:
1. ç§»é™¤ InExpr ä¸­çš„ static SubqueryExecutor (expression.cpp:1456)
2. ç§»é™¤ ExistsExpr ä¸­çš„ static SubqueryExecutor (expression.cpp:1631)
3. ç§»é™¤ ComparisonExpr ä¸­çš„ static SubqueryExecutor (expression.cpp:710, 739)
4. ç§»é™¤ SubqueryExpr ä¸­çš„ static SubqueryExecutor (expression.cpp:1366)
5. ç§»é™¤ ComparisonExpr çš„ mutable ç¼“å­˜å˜é‡ (expression.h:460-461)
6. ç§»é™¤ SubqueryExpr çš„ mutable ç¼“å­˜å˜é‡ (expression.h:720-721)
7. ç§»é™¤ç›¸å…³ç¼“å­˜æ¸…ç†æ–¹æ³•

é—®é¢˜æè¿°:
- static SubqueryExecutor å¯¼è‡´è·¨æŸ¥è¯¢å…±äº«ç¼“å­˜
- mutable ç¼“å­˜å˜é‡å¯¼è‡´è·¨ Tuple çš„çŠ¶æ€æ±¡æŸ“
- ç›¸åŒSQLåœ¨ä¸åŒæ•°æ®ä¸‹è¿”å›é”™è¯¯çš„æ—§ç»“æœ

è§£å†³æ–¹æ¡ˆ:
- æ¯æ¬¡åˆ›å»ºæ–°çš„ SubqueryExecutor å®ä¾‹
- ç§»é™¤æ‰€æœ‰ mutable ç¼“å­˜æœºåˆ¶
- ç¡®ä¿æ¯æ¬¡æŸ¥è¯¢éƒ½é‡æ–°æ‰§è¡Œï¼Œä¿è¯æ•°æ®æ­£ç¡®æ€§
```

### ç¬¬äºŒè½®ä¿®å¤ (å¾…æ¨é€)

```
fix: ç¦ç”¨ SubqueryExecutor å®ä¾‹çº§ç¼“å­˜

æ ¸å¿ƒä¿®å¤:
- å°† cache_enabled_ ä» true æ”¹ä¸º false (subquery_executor.cpp:25)

é—®é¢˜æè¿°:
- è™½ç„¶ç§»é™¤äº† static SubqueryExecutorï¼Œä½†å®ä¾‹å†…éƒ¨ä»æœ‰ç¼“å­˜
- ç¼“å­˜é”®åªåŸºäº SQL ç»“æ„ï¼Œä¸åŒ…å«æ•°æ®å†…å®¹
- å¯èƒ½å¯¼è‡´å•ä¸ªå®ä¾‹å†…å¤šæ¬¡è°ƒç”¨æ—¶çš„ç¼“å­˜æ±¡æŸ“

è§£å†³æ–¹æ¡ˆ:
- å®Œå…¨ç¦ç”¨ SubqueryExecutor çš„å®ä¾‹çº§ç¼“å­˜
- é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œç¡®ä¿é›¶ç¼“å­˜æ±¡æŸ“é£é™©
- ç”±äºå®ä¾‹ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œå®ä¾‹çº§ç¼“å­˜ä»·å€¼æœ‰é™
```

---

**æ–‡æ¡£ç»“æŸ** - 2025-10-18
