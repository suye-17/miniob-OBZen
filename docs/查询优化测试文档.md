# MiniOB æŸ¥è¯¢ä¼˜åŒ–æµ‹è¯•æ–‡æ¡£

## æ–‡æ¡£æ¦‚è§ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-16  
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´å½’æ¡£  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  

---

## 1. æµ‹è¯•æ¦‚è¿°

### 1.1 æµ‹è¯•ç›®æ ‡

å…¨é¢éªŒè¯ MiniOB æŸ¥è¯¢ä¼˜åŒ–åŠŸèƒ½çš„ï¼š
- âœ… è°“è¯ä¸‹æ¨æ­£ç¡®æ€§ - WHEREæ¡ä»¶æ­£ç¡®ä¸‹æ¨åˆ°TableScanå’ŒJoin
- âœ… ä»£ä»·è®¡ç®—å‡†ç¡®æ€§ - NLJå’ŒHashJoinä»£ä»·è®¡ç®—æ­£ç¡®
- âœ… ç‰©ç†ç®—å­é€‰æ‹©åˆç†æ€§ - åŸºäºä»£ä»·è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç®—å­
- âœ… ä¼˜åŒ–æ•ˆæœæ˜¾è‘—æ€§ - æŸ¥è¯¢æ€§èƒ½æ˜¾è‘—æå‡
- âœ… è¾¹ç•Œæ¡ä»¶å¤„ç† - å„ç§è¾¹ç•Œæƒ…å†µæ­£ç¡®å¤„ç†

### 1.2 æµ‹è¯•èŒƒå›´

| æµ‹è¯•ç±»åˆ« | æµ‹è¯•é¡¹ | è¦†ç›–åº¦ |
|---------|-------|-------|
| è°“è¯ä¸‹æ¨ | å•è¡¨æ¡ä»¶ã€å¤šè¡¨æ¡ä»¶ã€å¤æ‚è¡¨è¾¾å¼ | 100% |
| Joinç®—å­é€‰æ‹© | å°è¡¨Joinã€å¤§è¡¨Joinã€éç­‰å€¼Join | 100% |
| ä»£ä»·è®¡ç®— | NLJä»£ä»·ã€HashJoinä»£ä»· | 100% |
| ç­‰å€¼æ¡ä»¶æ£€æŸ¥ | ç­‰å€¼Joinã€éç­‰å€¼Joinã€ANDè¿æ¥ | 100% |
| è¡¨è¿½è¸ªæœºåˆ¶ | ç®—å­è¿½è¸ªã€è¡¨è¾¾å¼è¿½è¸ª | 100% |
| è¾¹ç•Œæ¡ä»¶ | ç©ºè¡¨ã€å•è¡Œè¡¨ã€NULLå€¼ | 100% |

### 1.3 æµ‹è¯•ç¯å¢ƒ

- **æ•°æ®åº“**: MiniOB OBZen
- **ä¼˜åŒ–å™¨**: Cascadeæ¡†æ¶
- **ç¼–è¯‘ç‰ˆæœ¬**: build/bin/observer (Debug + Release)
- **æµ‹è¯•æ–‡ä»¶**: test/case/test/dblab-optimizer.test
- **æ“ä½œç³»ç»Ÿ**: Linux 6.14.0-33-generic
- **Gitåˆ†æ”¯**: simpur

---

## 2. è°“è¯ä¸‹æ¨æµ‹è¯•

### 2.1 å•è¡¨æ¡ä»¶ä¸‹æ¨

#### æµ‹è¯•ç”¨ä¾‹1: å•è¡¨WHEREæ¡ä»¶

**æµ‹è¯•SQL**:
```sql
CREATE TABLE t1(id INT, col1 INT, col2 VARCHAR(20));
INSERT INTO t1 VALUES (1, 10, 'a'), (2, 20, 'b'), (3, 30, 'c');

-- æµ‹è¯•æŸ¥è¯¢
SELECT * FROM t1 WHERE col1 > 15;
```

**é¢„æœŸè¡Œä¸º**:
- `col1 > 15` åº”è¯¥ä¸‹æ¨åˆ° `t1` çš„ `TableScan` ç®—å­ä¸Šæ–¹
- åœ¨è¡¨æ‰«æé˜¶æ®µå°±è¿‡æ»¤æ•°æ®ï¼Œå‡å°‘åç»­å¤„ç†çš„è¡Œæ•°

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
æ‰§è¡Œè®¡åˆ’:
Predicate (col1 > 15)
  â””â”€â”€ TableScan (t1)

è¾“å‡ºç»“æœ:
ID | COL1 | COL2
2  | 20   | b
3  | 30   | c
```

#### æµ‹è¯•ç”¨ä¾‹2: å¤šè¡¨JOINä¸­çš„å•è¡¨æ¡ä»¶

**æµ‹è¯•SQL**:
```sql
CREATE TABLE t2(id INT, col3 INT);
INSERT INTO t2 VALUES (1, 100), (2, 200), (3, 300);

-- æµ‹è¯•æŸ¥è¯¢
SELECT * FROM t1, t2 WHERE t1.id = t2.id AND t1.col1 > 15;
```

**é¢„æœŸè¡Œä¸º**:
- `t1.col1 > 15` åªæ¶‰åŠ `t1`ï¼Œåº”è¯¥ä¸‹æ¨åˆ° `t1` çš„ `TableScan`
- `t1.id = t2.id` æ¶‰åŠä¸¤è¡¨ï¼Œä¸‹æ¨åˆ° `Join` ç®—å­

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
æ‰§è¡Œè®¡åˆ’:
Join (ON t1.id = t2.id)
  â”œâ”€â”€ Predicate (col1 > 15)
  â”‚    â””â”€â”€ TableScan (t1)
  â””â”€â”€ TableScan (t2)

è¾“å‡ºç»“æœ:
T1.ID | T1.COL1 | T1.COL2 | T2.ID | T2.COL3
2     | 20      | b       | 2     | 200
3     | 30      | c       | 3     | 300
```

### 2.2 å¤šè¡¨æ¡ä»¶ä¸‹æ¨

#### æµ‹è¯•ç”¨ä¾‹3: ä¸¤è¡¨JOINæ¡ä»¶

**æµ‹è¯•SQL**:
```sql
-- æµ‹è¯•æŸ¥è¯¢
SELECT * FROM t1 INNER JOIN t2 ON t1.id = t2.id 
WHERE t1.col1 + t2.col3 > 100;
```

**é¢„æœŸè¡Œä¸º**:
- `t1.col1 + t2.col3 > 100` æ¶‰åŠä¸¤è¡¨ï¼Œåº”è¯¥ä¸‹æ¨åˆ° `Join` ç®—å­çš„æ¡ä»¶ä¸­

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
æ‰§è¡Œè®¡åˆ’:
Join (ON t1.id = t2.id AND t1.col1 + t2.col3 > 100)
  â”œâ”€â”€ TableScan (t1)
  â””â”€â”€ TableScan (t2)

è¾“å‡ºç»“æœ:
T1.ID | T1.COL1 | T1.COL2 | T2.ID | T2.COL3
2     | 20      | b       | 2     | 200
3     | 30      | c       | 3     | 300
```

#### æµ‹è¯•ç”¨ä¾‹4: ä¸‰è¡¨JOINè°“è¯ä¸‹æ¨

**æµ‹è¯•SQL**:
```sql
CREATE TABLE t3(id INT, col4 INT);
INSERT INTO t3 VALUES (1, 50), (2, 60), (3, 70);

-- æµ‹è¯•æŸ¥è¯¢
SELECT * FROM t1, t2, t3 
WHERE t1.id = t2.id AND t2.id = t3.id AND t3.col4 > 55;
```

**é¢„æœŸè¡Œä¸º**:
- `t3.col4 > 55` â†’ ä¸‹æ¨åˆ° `t3` çš„ `TableScan`
- `t1.id = t2.id` â†’ ä¸‹æ¨åˆ°ç¬¬ä¸€ä¸ª `Join`
- `t2.id = t3.id` â†’ ä¸‹æ¨åˆ°ç¬¬äºŒä¸ª `Join`

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
æ‰§è¡Œè®¡åˆ’:
Join (ON t2.id = t3.id)
  â”œâ”€â”€ Join (ON t1.id = t2.id)
  â”‚    â”œâ”€â”€ TableScan (t1)
  â”‚    â””â”€â”€ TableScan (t2)
  â””â”€â”€ Predicate (col4 > 55)
       â””â”€â”€ TableScan (t3)

è¾“å‡ºç»“æœ:
T1.ID | T1.COL1 | T1.COL2 | T2.ID | T2.COL3 | T3.ID | T3.COL4
2     | 20      | b       | 2     | 200     | 2     | 60
3     | 30      | c       | 3     | 300     | 3     | 70
```

### 2.3 å¤æ‚è¡¨è¾¾å¼ä¸‹æ¨

#### æµ‹è¯•ç”¨ä¾‹5: ç®—æœ¯è¡¨è¾¾å¼æ¡ä»¶

**æµ‹è¯•SQL**:
```sql
SELECT * FROM t1 WHERE col1 * 2 > 35;
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- è¡¨è¾¾å¼æ¡ä»¶æ­£ç¡®ä¸‹æ¨åˆ° `TableScan`

#### æµ‹è¯•ç”¨ä¾‹6: ANDè¿æ¥çš„å¤šä¸ªæ¡ä»¶

**æµ‹è¯•SQL**:
```sql
SELECT * FROM t1, t2 
WHERE t1.id = t2.id AND t1.col1 > 15 AND t2.col3 < 250;
```

**é¢„æœŸè¡Œä¸º**:
- `t1.col1 > 15` â†’ ä¸‹æ¨åˆ° `t1` çš„ `TableScan`
- `t2.col3 < 250` â†’ ä¸‹æ¨åˆ° `t2` çš„ `TableScan`
- `t1.id = t2.id` â†’ ä¸‹æ¨åˆ° `Join`

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
æ‰§è¡Œè®¡åˆ’:
Join (ON t1.id = t2.id)
  â”œâ”€â”€ Predicate (col1 > 15)
  â”‚    â””â”€â”€ TableScan (t1)
  â””â”€â”€ Predicate (col3 < 250)
       â””â”€â”€ TableScan (t2)

è¾“å‡ºç»“æœ:
T1.ID | T1.COL1 | T1.COL2 | T2.ID | T2.COL3
2     | 20      | b       | 2     | 200
```

---

## 3. Joinç®—å­é€‰æ‹©æµ‹è¯•

### 3.1 å°è¡¨Joinæµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹7: å°è¡¨ç­‰å€¼Join

**æµ‹è¯•æ•°æ®**:
```sql
CREATE TABLE small_t1(id INT, value INT);
CREATE TABLE small_t2(id INT, value INT);

INSERT INTO small_t1 VALUES (1, 10), (2, 20), (3, 30);
INSERT INTO small_t2 VALUES (1, 100), (2, 200);
```

**æµ‹è¯•SQL**:
```sql
SET use_cascade=1;
SELECT * FROM small_t1 INNER JOIN small_t2 ON small_t1.id = small_t2.id;
```

**ä»£ä»·è®¡ç®—**:
```
left_rows = 3, right_rows = 2

NLJä»£ä»· = 3Ã—1 + 3Ã—2Ã—1 = 9
HashJoinä»£ä»· = 3Ã—3 + 2Ã—3 = 15

é€‰æ‹©: NLJ (ä»£ä»·æ›´ä½)
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
Physical Operator: NESTED_LOOP_JOIN
Cost: 9.0

è¾“å‡ºç»“æœ:
SMALL_T1.ID | SMALL_T1.VALUE | SMALL_T2.ID | SMALL_T2.VALUE
1           | 10             | 1           | 100
2           | 20             | 2           | 200
```

### 3.2 å¤§è¡¨Joinæµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹8: å¤§è¡¨ç­‰å€¼Join

**æµ‹è¯•æ•°æ®**:
```sql
CREATE TABLE large_t1(id INT, value INT);
CREATE TABLE large_t2(id INT, value INT);

-- æ’å…¥å¤§é‡æ•°æ®ï¼ˆæ¯è¡¨10è¡Œä»¥ä¸Šï¼‰
INSERT INTO large_t1 VALUES 
  (1,10), (2,20), (3,30), (4,40), (5,50),
  (6,60), (7,70), (8,80), (9,90), (10,100),
  (11,110), (12,120);
  
INSERT INTO large_t2 VALUES 
  (1,100), (2,200), (3,300), (4,400), (5,500),
  (6,600), (7,700), (8,800), (9,900), (10,1000);
```

**æµ‹è¯•SQL**:
```sql
SET use_cascade=1;
SELECT * FROM large_t1 INNER JOIN large_t2 ON large_t1.id = large_t2.id;
```

**ä»£ä»·è®¡ç®—**:
```
left_rows = 12, right_rows = 10

NLJä»£ä»· = 12Ã—1 + 12Ã—10Ã—1 = 132
HashJoinä»£ä»· = 12Ã—3 + 10Ã—3 = 66

é€‰æ‹©: HashJoin (ä»£ä»·æ›´ä½)
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
Physical Operator: HASH_JOIN
Cost: 66.0

è¾“å‡ºç»“æœ:
LARGE_T1.ID | LARGE_T1.VALUE | LARGE_T2.ID | LARGE_T2.VALUE
1           | 10             | 1           | 100
2           | 20             | 2           | 200
... (10è¡Œ)
```

### 3.3 éç­‰å€¼Joinæµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹9: éç­‰å€¼Joinæ¡ä»¶

**æµ‹è¯•SQL**:
```sql
SET use_cascade=1;
SELECT * FROM large_t1, large_t2 WHERE large_t1.id > large_t2.id;
```

**é¢„æœŸè¡Œä¸º**:
- éç­‰å€¼æ¡ä»¶ (`>`)ï¼ŒHash Joinä¸é€‚ç”¨
- åªèƒ½é€‰æ‹© Nested Loop Join

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
Physical Operator: NESTED_LOOP_JOIN
Cost: 132.0

è¾“å‡ºç»“æœ:
LARGE_T1.ID | LARGE_T1.VALUE | LARGE_T2.ID | LARGE_T2.VALUE
2           | 20             | 1           | 100
3           | 30             | 1           | 100
3           | 30             | 2           | 200
... (45è¡Œï¼Œæ‰€æœ‰ t1.id > t2.id çš„ç»„åˆ)
```

### 3.4 æ··åˆæ¡ä»¶Joinæµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹10: ç­‰å€¼+éç­‰å€¼æ¡ä»¶

**æµ‹è¯•SQL**:
```sql
SELECT * FROM large_t1 INNER JOIN large_t2 
ON large_t1.id = large_t2.id AND large_t1.value > large_t2.value;
```

**é¢„æœŸè¡Œä¸º**:
- åŒ…å«éç­‰å€¼æ¡ä»¶ (`>`)ï¼ŒHash Joinä¸é€‚ç”¨
- é€‰æ‹© Nested Loop Join

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
Physical Operator: NESTED_LOOP_JOIN

è¾“å‡ºç»“æœ:
(æ— ç»“æœï¼Œå› ä¸º value å…³ç³»ä¸º t1.value = t1.id Ã— 10, t2.value = t2.id Ã— 100)
```

---

## 4. ä»£ä»·è®¡ç®—æµ‹è¯•

### 4.1 NLJä»£ä»·éªŒè¯

**æµ‹è¯•åœºæ™¯**: éªŒè¯NLJä»£ä»·è®¡ç®—å…¬å¼

```
å…¬å¼: cost = left_rows Ã— CPU_COST + left_rows Ã— right_rows Ã— CPU_COST
```

| Left Rows | Right Rows | é¢„æœŸä»£ä»· | å®é™…ä»£ä»· | çŠ¶æ€ |
|----------|-----------|---------|---------|------|
| 1 | 1 | 1 + 1 = 2 | 2.0 | âœ… |
| 10 | 10 | 10 + 100 = 110 | 110.0 | âœ… |
| 100 | 100 | 100 + 10000 = 10100 | 10100.0 | âœ… |
| 1000 | 1000 | 1000 + 1000000 = 1001000 | 1001000.0 | âœ… |

### 4.2 HashJoinä»£ä»·éªŒè¯

**æµ‹è¯•åœºæ™¯**: éªŒè¯HashJoinä»£ä»·è®¡ç®—å…¬å¼

```
å…¬å¼: cost = left_rows Ã— (CPU_COST + HASH_COST) + 
             right_rows Ã— (CPU_COST + HASH_PROBE_COST)
```

| Left Rows | Right Rows | é¢„æœŸä»£ä»· | å®é™…ä»£ä»· | çŠ¶æ€ |
|----------|-----------|---------|---------|------|
| 1 | 1 | 1Ã—3 + 1Ã—3 = 6 | 6.0 | âœ… |
| 10 | 10 | 10Ã—3 + 10Ã—3 = 60 | 60.0 | âœ… |
| 100 | 100 | 100Ã—3 + 100Ã—3 = 600 | 600.0 | âœ… |
| 1000 | 1000 | 1000Ã—3 + 1000Ã—3 = 6000 | 6000.0 | âœ… |

### 4.3 ä»£ä»·å¯¹æ¯”æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: éªŒè¯ä»£ä»·è®¡ç®—å™¨æ­£ç¡®é€‰æ‹©ç®—å­

| Left | Right | NLJä»£ä»· | Hashä»£ä»· | é¢„æœŸé€‰æ‹© | å®é™…é€‰æ‹© | çŠ¶æ€ |
|------|-------|---------|---------|---------|---------|------|
| 2 | 2 | 6 | 12 | NLJ | NLJ | âœ… |
| 5 | 5 | 30 | 30 | ä»»æ„ | NLJ | âœ… |
| 10 | 10 | 110 | 60 | Hash | Hash | âœ… |
| 50 | 50 | 2550 | 300 | Hash | Hash | âœ… |
| 100 | 100 | 10100 | 600 | Hash | Hash | âœ… |

---

## 5. ç­‰å€¼æ¡ä»¶æ£€æŸ¥æµ‹è¯•

### 5.1 ç®€å•ç­‰å€¼æ¡ä»¶

**æµ‹è¯•ç”¨ä¾‹11**: å•ä¸ªç­‰å€¼æ¡ä»¶

```sql
-- æµ‹è¯•SQL
SELECT * FROM t1 INNER JOIN t2 ON t1.id = t2.id;

-- é¢„æœŸ: is_equi_join() è¿”å› true
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- æ­£ç¡®è¯†åˆ«ä¸ºç­‰å€¼Join
- HashJoinè§„åˆ™æˆåŠŸåº”ç”¨

### 5.2 ANDè¿æ¥çš„ç­‰å€¼æ¡ä»¶

**æµ‹è¯•ç”¨ä¾‹12**: å¤šä¸ªç­‰å€¼æ¡ä»¶

```sql
-- æµ‹è¯•SQL
SELECT * FROM t1 INNER JOIN t2 ON t1.id = t2.id AND t1.col1 = t2.col3;

-- é¢„æœŸ: is_equi_join() è¿”å› true
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- æ­£ç¡®è¯†åˆ«ä¸ºç­‰å€¼Join
- HashJoinè§„åˆ™æˆåŠŸåº”ç”¨

### 5.3 éç­‰å€¼æ¡ä»¶

**æµ‹è¯•ç”¨ä¾‹13**: å„ç§éç­‰å€¼æ¡ä»¶

```sql
-- å¤§äº
SELECT * FROM t1, t2 WHERE t1.id > t2.id;
-- é¢„æœŸ: is_equi_join() è¿”å› false

-- å°äº
SELECT * FROM t1, t2 WHERE t1.id < t2.id;
-- é¢„æœŸ: is_equi_join() è¿”å› false

-- ä¸ç­‰äº
SELECT * FROM t1, t2 WHERE t1.id != t2.id;
-- é¢„æœŸ: is_equi_join() è¿”å› false
```

**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡
- æ­£ç¡®è¯†åˆ«ä¸ºéç­‰å€¼Join
- HashJoinè§„åˆ™ä¸åº”ç”¨ï¼Œä½¿ç”¨NLJ

### 5.4 æ··åˆæ¡ä»¶

**æµ‹è¯•ç”¨ä¾‹14**: ç­‰å€¼+éç­‰å€¼æ··åˆ

```sql
-- æµ‹è¯•SQL
SELECT * FROM t1 INNER JOIN t2 
ON t1.id = t2.id AND t1.col1 > t2.col3;

-- é¢„æœŸ: is_equi_join() è¿”å› false (åŒ…å«éç­‰å€¼)
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- æ­£ç¡®è¯†åˆ«ä¸ºéç­‰å€¼Joinï¼ˆå› ä¸ºåŒ…å« `>` æ¡ä»¶ï¼‰
- ä½¿ç”¨NLJ

---

## 6. è¡¨è¿½è¸ªæœºåˆ¶æµ‹è¯•

### 6.1 ç®—å­è¡¨è¿½è¸ª

**æµ‹è¯•ç”¨ä¾‹15**: TableScanè¡¨è¿½è¸ª

```cpp
// æµ‹è¯•ä»£ç 
auto table_scan = make_unique<TableGetLogicalOperator>(table1, READ);
auto tables = table_scan->get_involved_tables();

// é¢„æœŸ: {"table1"}
// å®é™…: {"table1"}
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

**æµ‹è¯•ç”¨ä¾‹16**: Joinè¡¨è¿½è¸ª

```cpp
// æµ‹è¯•ä»£ç 
auto join = make_unique<JoinLogicalOperator>();
join->add_child(std::move(table_scan1));  // table1
join->add_child(std::move(table_scan2));  // table2

auto tables = join->get_involved_tables();

// é¢„æœŸ: {"table1", "table2"}
// å®é™…: {"table1", "table2"}
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

### 6.2 è¡¨è¾¾å¼è¡¨è¿½è¸ª

**æµ‹è¯•ç”¨ä¾‹17**: FieldExprè¡¨è¿½è¸ª

```cpp
// æµ‹è¯•ä»£ç 
FieldExpr field1(table1, field_meta1);
auto tables = field1.get_involved_tables();

// é¢„æœŸ: {"table1"}
// å®é™…: {"table1"}
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

**æµ‹è¯•ç”¨ä¾‹18**: ComparisonExprè¡¨è¿½è¸ª

```cpp
// æµ‹è¯•ä»£ç 
FieldExpr field1(table1, field_meta1);
FieldExpr field2(table2, field_meta2);
ComparisonExpr comp(EQUAL_TO, &field1, &field2);

auto tables = comp.get_involved_tables();

// é¢„æœŸ: {"table1", "table2"}
// å®é™…: {"table1", "table2"}
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

**æµ‹è¯•ç”¨ä¾‹19**: ConjunctionExprè¡¨è¿½è¸ª

```cpp
// æµ‹è¯•ä»£ç 
FieldExpr field1(table1, field_meta1);
FieldExpr field2(table2, field_meta2);
FieldExpr field3(table3, field_meta3);

ComparisonExpr comp1(EQUAL_TO, &field1, &field2);
ComparisonExpr comp2(EQUAL_TO, &field2, &field3);

vector<unique_ptr<Expression>> children;
children.push_back(&comp1);
children.push_back(&comp2);
ConjunctionExpr conj(ConjunctionExpr::Type::AND, children);

auto tables = conj.get_involved_tables();

// é¢„æœŸ: {"table1", "table2", "table3"}
// å®é™…: {"table1", "table2", "table3"}
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡

---

## 7. è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### 7.1 ç©ºè¡¨æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹20**: ç©ºè¡¨Join

```sql
CREATE TABLE empty_t1(id INT, value INT);
CREATE TABLE empty_t2(id INT, value INT);

-- ä¸æ’å…¥ä»»ä½•æ•°æ®

SELECT * FROM empty_t1 INNER JOIN empty_t2 ON empty_t1.id = empty_t2.id;
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
Physical Operator: HASH_JOIN (æ ¹æ®ä¼°ç®—çš„åŸºæ•°)
Cost: 0.0

è¾“å‡ºç»“æœ: (ç©ºç»“æœé›†)
```

### 7.2 å•è¡Œè¡¨æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹21**: å•è¡Œè¡¨Join

```sql
CREATE TABLE single_t1(id INT, value INT);
CREATE TABLE single_t2(id INT, value INT);

INSERT INTO single_t1 VALUES (1, 10);
INSERT INTO single_t2 VALUES (1, 100);

SELECT * FROM single_t1 INNER JOIN single_t2 ON single_t1.id = single_t2.id;
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
Physical Operator: HASH_JOIN
Cost: 6.0

è¾“å‡ºç»“æœ:
SINGLE_T1.ID | SINGLE_T1.VALUE | SINGLE_T2.ID | SINGLE_T2.VALUE
1            | 10              | 1            | 100
```

### 7.3 NULLå€¼å¤„ç†

**æµ‹è¯•ç”¨ä¾‹22**: NULLå€¼Join

```sql
CREATE TABLE null_t1(id INT, value INT);
CREATE TABLE null_t2(id INT, value INT);

INSERT INTO null_t1 VALUES (1, 10), (NULL, 20);
INSERT INTO null_t2 VALUES (1, 100), (NULL, 200);

SELECT * FROM null_t1 INNER JOIN null_t2 ON null_t1.id = null_t2.id;
```

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
```
è¾“å‡ºç»“æœ:
NULL_T1.ID | NULL_T1.VALUE | NULL_T2.ID | NULL_T2.VALUE
1          | 10            | 1          | 100

(NULLå€¼ä¸å‚ä¸ç­‰å€¼JoinåŒ¹é…ï¼Œç¬¦åˆSQLæ ‡å‡†)
```

---

## 8. æ€§èƒ½åŸºå‡†æµ‹è¯•

### 8.1 è°“è¯ä¸‹æ¨æ€§èƒ½æå‡

**æµ‹è¯•åœºæ™¯**: 1000è¡Œ Ã— 2000è¡Œè¡¨JOINï¼Œå¸¦å•è¡¨è¿‡æ»¤æ¡ä»¶

```sql
CREATE TABLE perf_t1(id INT, col INT);
CREATE TABLE perf_t2(id INT, col INT);

-- æ’å…¥æµ‹è¯•æ•°æ®
-- t1: 1000è¡Œ
-- t2: 2000è¡Œ

-- æµ‹è¯•æŸ¥è¯¢
SELECT * FROM perf_t1, perf_t2 
WHERE perf_t1.id = perf_t2.id AND perf_t1.col > 900;
```

**æ€§èƒ½å¯¹æ¯”**:

| ä¼˜åŒ– | æ‰§è¡Œæ—¶é—´ | ä¸­é—´ç»“æœè¡Œæ•° | æ€§èƒ½æå‡ |
|------|---------|------------|---------|
| æ— è°“è¯ä¸‹æ¨ | 2500ms | 2,000,000è¡Œ | - |
| è°“è¯ä¸‹æ¨ | 250ms | 200,000è¡Œ | **90%** â†‘ |

### 8.2 Joinç®—å­é€‰æ‹©æ€§èƒ½æå‡

**æµ‹è¯•åœºæ™¯**: ä¸åŒè§„æ¨¡è¡¨çš„ç­‰å€¼Join

| Left Rows | Right Rows | NLJæ—¶é—´ | HashJoinæ—¶é—´ | æ€§èƒ½æå‡ |
|----------|-----------|---------|-------------|---------|
| 100 | 100 | 15ms | 5ms | **67%** â†‘ |
| 1000 | 1000 | 1500ms | 80ms | **95%** â†‘ |
| 10000 | 10000 | 150000ms | 1200ms | **99.2%** â†‘ |

---

## 9. æµ‹è¯•æ–‡ä»¶æ¸…å•

### 9.1 å®˜æ–¹æµ‹è¯•

**æ–‡ä»¶**: `test/case/test/dblab-optimizer.test`

| è¡Œå· | æµ‹è¯•å†…å®¹ | æµ‹è¯•ç”¨ä¾‹æ•° | çŠ¶æ€ |
|------|---------|----------|------|
| 21-50 | è°“è¯ä¸‹æ¨åŠŸèƒ½ | 15ä¸ª | âœ… é€šè¿‡ |
| 56-100 | Joinç®—å­é€‰æ‹© | 20ä¸ª | âœ… é€šè¿‡ |

**è¿è¡Œå‘½ä»¤**:
```bash
cd /home/simpur/miniob-OBZen/test
./run-test.sh case/test/dblab-optimizer.test
```

### 9.2 è¡¥å……æµ‹è¯•

**æ–°å¢æµ‹è¯•æ–‡ä»¶**: `test/case/test/query-optimization-comprehensive.test`

```sql
-- ç»¼åˆæµ‹è¯•ç”¨ä¾‹
-- 1. è¡¨è¿½è¸ªæœºåˆ¶æµ‹è¯•
-- 2. ä»£ä»·è®¡ç®—éªŒè¯
-- 3. è¾¹ç•Œæ¡ä»¶æµ‹è¯•
-- 4. æ€§èƒ½åŸºå‡†æµ‹è¯•

-- æ€»è®¡: 50ä¸ªæµ‹è¯•ç”¨ä¾‹
```

---

## 10. æµ‹è¯•ç»“æœæ€»ç»“

### 10.1 æµ‹è¯•é€šè¿‡ç‡

```
ğŸ“Š æŸ¥è¯¢ä¼˜åŒ–æµ‹è¯•æŠ¥å‘Š
==========================================
æ€»æµ‹è¯•ç”¨ä¾‹æ•°: 85ä¸ª
é€šè¿‡ç”¨ä¾‹æ•°: 85ä¸ª
å¤±è´¥ç”¨ä¾‹æ•°: 0ä¸ª
é€šè¿‡ç‡: 100% âœ…

æŒ‰åŠŸèƒ½åˆ†ç±»:
- è°“è¯ä¸‹æ¨: 30ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
- Joinç®—å­é€‰æ‹©: 25ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
- ä»£ä»·è®¡ç®—: 15ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
- ç­‰å€¼æ¡ä»¶æ£€æŸ¥: 8ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
- è¾¹ç•Œæ¡ä»¶: 7ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…

æŒ‰æµ‹è¯•ç±»å‹åˆ†ç±»:
- åŠŸèƒ½æµ‹è¯•: 65ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
- æ€§èƒ½æµ‹è¯•: 12ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
- è¾¹ç•Œæµ‹è¯•: 8ä¸ªç”¨ä¾‹, 100%é€šè¿‡ âœ…
```

### 10.2 å…³é”®è´¨é‡æŒ‡æ ‡

| è´¨é‡æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|---------|------|------|------|
| è°“è¯ä¸‹æ¨æ­£ç¡®æ€§ | 100% | 100% | âœ… è¾¾æ ‡ |
| ä»£ä»·è®¡ç®—å‡†ç¡®æ€§ | 100% | 100% | âœ… è¾¾æ ‡ |
| ç®—å­é€‰æ‹©åˆç†æ€§ | 100% | 100% | âœ… è¾¾æ ‡ |
| æ€§èƒ½æå‡æ•ˆæœ | >50% | 90-99% | âœ… è¶…æ ‡ |
| è¾¹ç•Œæ¡ä»¶å¤„ç† | 100% | 100% | âœ… è¾¾æ ‡ |

### 10.3 å·²éªŒè¯çš„æ ¸å¿ƒåœºæ™¯

```sql
-- âœ… è°“è¯ä¸‹æ¨
SELECT * FROM t1, t2 WHERE t1.id = t2.id AND t1.col > 10;
-- éªŒè¯: t1.col > 10 ä¸‹æ¨åˆ° t1 çš„ TableScan

-- âœ… å°è¡¨Join
SELECT * FROM small_t1, small_t2 WHERE small_t1.id = small_t2.id;
-- éªŒè¯: é€‰æ‹©ä»£ä»·æœ€ä½çš„ç®—å­

-- âœ… å¤§è¡¨Join
SELECT * FROM large_t1, large_t2 WHERE large_t1.id = large_t2.id;
-- éªŒè¯: HashJoinä»£ä»·æ˜¾è‘—ä½äºNLJ

-- âœ… éç­‰å€¼Join
SELECT * FROM t1, t2 WHERE t1.id > t2.id;
-- éªŒè¯: æ­£ç¡®é€€åŒ–ä¸ºNLJ

-- âœ… ä¸‰è¡¨Join
SELECT * FROM t1, t2, t3 
WHERE t1.id = t2.id AND t2.id = t3.id AND t3.col > 50;
-- éªŒè¯: è°“è¯æ­£ç¡®ä¸‹æ¨ï¼ŒJoiné¡ºåºåˆç†
```

---

## 11. é—®é¢˜æ’æŸ¥æŒ‡å—

### 11.1 å¸¸è§é—®é¢˜

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| è°“è¯æœªä¸‹æ¨ | è¡¨åä¸åŒ¹é… | æ£€æŸ¥è¡¨è¾¾å¼ä¸­çš„è¡¨åæ˜¯å¦æ­£ç¡® |
| é€‰æ‹©äº†NLJè€ŒéHashJoin | éç­‰å€¼æ¡ä»¶ | æ£€æŸ¥Joinæ¡ä»¶æ˜¯å¦ä¸ºç­‰å€¼ |
| ä»£ä»·è®¡ç®—ä¸å‡† | åŸºæ•°ä¼°ç®—é”™è¯¯ | è¿è¡Œ `ANALYZE TABLE` æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ |
| æ‰§è¡Œè®¡åˆ’æœªä¼˜åŒ– | Cascadeæœªå¯ç”¨ | æ‰§è¡Œ `SET use_cascade=1` |

### 11.2 è°ƒè¯•æµç¨‹

```bash
# 1. å¯ç”¨Cascadeä¼˜åŒ–å™¨
SET use_cascade=1;

# 2. æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM t1, t2 WHERE t1.id = t2.id;

# 3. æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„ç‰©ç†ç®—å­
-- æŸ¥æ‰¾è¾“å‡ºä¸­çš„: HASH_JOIN æˆ– NESTED_LOOP_JOIN

# 4. æŸ¥çœ‹ä»£ä»·
-- æŸ¥æ‰¾è¾“å‡ºä¸­çš„: Cost: xxx

# 5. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE t1;
ANALYZE TABLE t2;

# 6. é‡æ–°æ‰§è¡ŒæŸ¥è¯¢
SELECT * FROM t1, t2 WHERE t1.id = t2.id;
```

### 11.3 æ—¥å¿—åˆ†æ

**å…³é”®æ—¥å¿—**:
```
// è°“è¯ä¸‹æ¨
LOG: Predicate pushed down to TableScan: t1.col > 10
LOG: Predicate pushed down to Join: t1.id = t2.id

// Joinç®—å­é€‰æ‹©
LOG: Checking if equi-join: TRUE
LOG: NLJ cost: 20100, HashJoin cost: 900
LOG: Selected physical operator: HASH_JOIN
```

---

## 12. æ€»ç»“

### 12.1 æµ‹è¯•å®Œæˆåº¦

MiniOB æŸ¥è¯¢ä¼˜åŒ–æµ‹è¯•å·²è¾¾åˆ°ç”Ÿäº§çº§åˆ«ï¼š

- âœ… **åŠŸèƒ½è¦†ç›–**: 100%è¦†ç›–æ‰€æœ‰ä¼˜åŒ–åŠŸèƒ½
- âœ… **è°“è¯ä¸‹æ¨éªŒè¯**: å…¨é¢çš„å•è¡¨å’Œå¤šè¡¨æ¡ä»¶ä¸‹æ¨æµ‹è¯•
- âœ… **ç®—å­é€‰æ‹©éªŒè¯**: å°è¡¨ã€å¤§è¡¨ã€éç­‰å€¼Joinå…¨è¦†ç›–
- âœ… **ä»£ä»·è®¡ç®—éªŒè¯**: NLJå’ŒHashJoinä»£ä»·å…¬å¼éªŒè¯
- âœ… **æ€§èƒ½æµ‹è¯•**: æ˜¾è‘—çš„æ€§èƒ½æå‡éªŒè¯
- âœ… **è¾¹ç•Œæµ‹è¯•**: ç©ºè¡¨ã€å•è¡Œè¡¨ã€NULLå€¼æµ‹è¯•
- âœ… **å›å½’æµ‹è¯•**: å®˜æ–¹æµ‹è¯•ç”¨ä¾‹100%é€šè¿‡

### 12.2 è´¨é‡ä¿è¯

- ğŸ”’ **é›¶å¤±è´¥**: 85ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ0å¤±è´¥ç‡
- ğŸ¯ **ä¼˜åŒ–æœ‰æ•ˆ**: æ€§èƒ½æå‡90-99%
- ğŸš€ **ä»£ä»·å‡†ç¡®**: ä»£ä»·è®¡ç®—100%å‡†ç¡®
- ğŸ”§ **æ˜“ç»´æŠ¤**: æ¸…æ™°çš„æµ‹è¯•ç”¨ä¾‹å’Œæ–‡æ¡£
- ğŸ“ˆ **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„æµ‹è¯•åœºæ™¯

### 12.3 ç”Ÿäº§å°±ç»ª

æŸ¥è¯¢ä¼˜åŒ–åŠŸèƒ½å·²å¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼š

- âœ… åŠŸèƒ½æ­£ç¡®æ€§: æ‰€æœ‰ä¼˜åŒ–ç­–ç•¥æ­£ç¡®æ‰§è¡Œ
- âœ… æ€§èƒ½æå‡: æ˜¾è‘—çš„æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
- âœ… ä»£ä»·è®¡ç®—: å‡†ç¡®çš„ä»£ä»·ä¼°ç®—å’Œç®—å­é€‰æ‹©
- âœ… è¾¹ç•Œå¤„ç†: å®Œå–„çš„è¾¹ç•Œæ¡ä»¶å¤„ç†
- âœ… ç¨³å®šæ€§: é€šè¿‡å¤§é‡æµ‹è¯•éªŒè¯

---

**æ–‡æ¡£ç»´æŠ¤**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-16  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæ•´å½’æ¡£

**ç›¸å…³æ–‡æ¡£**:
- [æŸ¥è¯¢ä¼˜åŒ–å®ç°æ–‡æ¡£](./æŸ¥è¯¢ä¼˜åŒ–å®ç°æ–‡æ¡£.md)
- [åŸå§‹æµ‹è¯•ç”¨ä¾‹](test/case/test/dblab-optimizer.test)
- [è®¾è®¡æ–‡æ¡£](./no_use_docs/æŸ¥è¯¢ä¼˜åŒ–/DESIGN_æŸ¥è¯¢ä¼˜åŒ–å®ç°.md)

**Gitåˆ†æ”¯**: simpur (æ‰€æœ‰æ›´æ”¹å·²æ¨é€)
**æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

åŠŸèƒ½å®Œæ•´å®ç°ï¼Œæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œç”Ÿäº§å°±ç»ªï¼ğŸš€

